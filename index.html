<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Survival Challenge</title>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<style>
  :root{
    --safeTop: env(safe-area-inset-top, 0px);
    --safeBottom: env(safe-area-inset-bottom, 0px);
    --card: rgba(255,255,255,.82);
    --stroke: rgba(0,0,0,.22);
    --shadow: rgba(0,0,0,.18);
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:
      radial-gradient(1200px 600px at 20% 0%, rgba(255,255,255,.18), transparent 60%),
      radial-gradient(900px 600px at 90% 20%, rgba(255,255,255,.12), transparent 55%),
      linear-gradient(180deg, #3b2a1e, #1f1510);
    color:#111;
    height:100svh;
    overflow:hidden;
  }

  /* wood-ish overlay */
  body:before{
    content:"";
    position:fixed; inset:0;
    background:
      repeating-linear-gradient(90deg, rgba(255,210,140,.09) 0px, rgba(255,210,140,.09) 22px, rgba(255,195,120,.08) 22px, rgba(255,195,120,.08) 44px),
      repeating-linear-gradient(0deg, rgba(0,0,0,.06) 0px, rgba(0,0,0,.06) 2px, transparent 2px, transparent 7px);
    mix-blend-mode: overlay;
    opacity:.55;
    pointer-events:none;
  }

  /* subtle grain */
  body:after{
    content:"";
    position:fixed; inset:0;
    background-image: repeating-linear-gradient(rgba(0,0,0,0.04) 0px, rgba(0,0,0,0.04) 2px, transparent 2px, transparent 6px);
    opacity:.35;
    pointer-events:none;
  }

  .screen{
    position:fixed; inset:0;
    padding: calc(14px + var(--safeTop)) 14px calc(14px + var(--safeBottom)) 14px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .panel{
    background: var(--card);
    border: 1px solid var(--stroke);
    border-radius: 18px;
    box-shadow: 0 10px 22px var(--shadow);
    backdrop-filter: blur(10px);
  }

  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .col{ display:flex; flex-direction:column; gap:10px; }
  .sp{ flex:1; }

  .titleWrap{
    display:flex;
    justify-content:center;
    align-items:center;
    text-align:center;
    padding: 12px 12px;
  }

  .gameTitle{
    font-weight: 900;
    font-size: 34px;
    letter-spacing: .2px;
    color: #fff7e6;
    text-shadow: 0 10px 24px rgba(0,0,0,.35);
    margin:0;
  }
  .byline{
    margin-top:6px;
    color: rgba(255,255,255,.85);
    font-size: 14px;
  }

  .startCard{
    padding:14px;
  }
  label{ font-size:14px; opacity:.85; }
  input, select{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.18);
    background: rgba(255,255,255,.92);
    outline:none;
    font-size:16px;
  }

  .btn{
    border:0;
    border-radius: 16px;
    padding: 12px 14px;
    font-weight: 800;
    font-size: 16px;
    cursor:pointer;
    box-shadow: 0 10px 16px rgba(0,0,0,.16);
    transition: transform .08s ease, filter .15s ease;
    user-select:none;
  }
  .btn:active{ transform: scale(.98); }
  .btnGreen{ background: linear-gradient(180deg, #47d26e, #20a84a); color:#07150b; }
  .btnRed{ background: linear-gradient(180deg, #ff6e6e, #e23b3b); color:#2b0707; }
  .btnGold{ background: linear-gradient(180deg, #ffe08a, #f2b64b); color:#241600; }
  .btnSoft{ background: rgba(255,255,255,.8); border:1px solid rgba(0,0,0,.15); box-shadow:none; }

  .pillGrid{
    padding:12px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:10px;
  }

  .pill{
    padding:10px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.75);
    border: 1px solid rgba(0,0,0,.14);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    font-weight: 700;
    min-height: 48px;
  }
  .pill small{ opacity:.75; font-weight:700; }

  .feed{
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .feedHead{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .feedBox{
    background: rgba(255,255,255,.88);
    border:1px solid rgba(0,0,0,.14);
    border-radius:14px;
    padding:10px;
    max-height: 140px;
    overflow:auto;
    font-size: 14px;
  }
  .feedItem{ padding:6px 0; border-bottom:1px dashed rgba(0,0,0,.14); }
  .feedItem:last-child{ border-bottom:0; }

  /* Night Card always visible (mobile + desktop) */
  .nightWrap{
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
    flex: 1 1 auto;
    min-height: 170px;
  }
  .nightHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .nightHeader h3{
    margin:0;
    font-size: 16px;
    font-weight: 900;
  }
  .nightCard{
    flex:1;
    background: rgba(255,255,255,.9);
    border: 1px solid rgba(0,0,0,.14);
    border-radius: 16px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 26px;
    font-weight: 900;
    text-align:center;
    padding: 14px;
    position:relative;
    overflow:hidden;
  }
  .nightCard .sub{
    font-size: 14px;
    opacity: .75;
    font-weight: 700;
    margin-top: 6px;
  }
  .pulse{
    animation: pulse .9s ease-in-out infinite alternate;
  }
  @keyframes pulse{
    from{ filter: brightness(1); transform: translateY(0); }
    to{ filter: brightness(1.06); transform: translateY(-1px); }
  }

  /* Bottom controls sticky on mobile */
  .controls{
    padding: 12px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    position: sticky;
    bottom: 0;
    background: rgba(255,255,255,.65);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(0,0,0,.12);
    border-radius: 18px;
  }

  .controls .btn{ font-size: 16px; padding: 14px 12px; }

  /* Modals */
  .overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.35);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 14px;
    z-index: 9999;
  }
  .modal{
    width:min(560px, 96vw);
    max-height: 86svh;
    overflow:auto;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(0,0,0,.18);
    border-radius: 18px;
    box-shadow: 0 20px 50px rgba(0,0,0,.30);
    backdrop-filter: blur(10px);
    padding: 14px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .modal h2{
    margin:0;
    font-size: 18px;
    font-weight: 900;
  }
  .modal .hint{
    font-size: 13px;
    opacity: .75;
    font-weight: 700;
  }
  .modalGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .modalList{
    border:1px dashed rgba(0,0,0,.22);
    border-radius: 14px;
    padding: 10px;
    background: rgba(255,255,255,.8);
  }
  .listRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding: 8px 0;
    border-bottom: 1px dashed rgba(0,0,0,.16);
    font-size: 14px;
    font-weight: 800;
  }
  .listRow:last-child{ border-bottom:0; }
  .tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(255,224,138,.65);
    border: 1px solid rgba(0,0,0,.12);
    font-weight: 900;
    font-size: 12px;
  }

  /* Responsive tweaks */
  @media (max-width: 760px){
    .pillGrid{ grid-template-columns: 1fr 1fr; }
    .controls{ grid-template-columns: 1fr 1fr; }
    .gameTitle{ font-size: 30px; }
  }

  /* Hide scrollbars a bit */
  .feedBox::-webkit-scrollbar { width: 8px; }
  .feedBox::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius: 10px; }
</style>
</head>

<body>

<!-- START -->
<div id="startScreen" class="screen">
  <div class="titleWrap">
  <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
    <img
      src="assets/logo.png"
      alt="Survival Challenge"
      style="width:min(320px, 78vw); height:auto; display:block; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));"
      onerror="this.style.display='none';"
    />
    <div class="byline">(by David Toma)</div>
  </div>
</div>

  <div class="panel startCard">
    <div class="col">
      <div class="row">
        <div class="sp">
          <label>Room code</label>
          <input id="roomInput" maxlength="6" placeholder="ABCD12" />
        </div>
      </div>

      <div class="row">
        <div class="sp">
          <label>Your name</label>
          <input id="nameInput" maxlength="14" placeholder="David" />
        </div>
      </div>

      <button id="joinBtn" class="btn btnGreen">Join / Create</button>
      <div class="hint" style="opacity:.8;font-weight:800;font-size:13px;">
        First player in room becomes <b>Challenger</b>. Max 4 players.
      </div>
    </div>
  </div>

  <div class="panel startCard">
    <div style="font-weight:900;">Game description (HR)</div>
    <div style="opacity:.85;font-weight:700;font-size:14px;line-height:1.35;">
      Igra za 3‚Äì4 igraƒça. Pre≈æivite <b>7 noƒái</b> kao Survivori. Challenger zadaje izazove i upravlja resursima.
      Ako Survivori naprave previ≈°e failova ili izgube srca ‚Äî Challenger pobjeƒëuje.
    </div>
    <div style="height:10px;"></div>
    <div style="font-weight:900;">Game description (EN)</div>
    <div style="opacity:.85;font-weight:700;font-size:14px;line-height:1.35;">
      A 3‚Äì4 player survival party game. Survivors must endure <b>7 nights</b>. The Challenger sets challenges and controls resources.
      Too many fails or hearts lost means the Challenger wins.
    </div>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen" style="display:none;">
  <!-- Top HUD -->
  <div id="topHUD" class="panel pillGrid">
    <div class="pill"><small>Phase</small><span id="phaseText">lobby</span></div>
    <div class="pill"><small>Role</small><span id="roleText">‚Äî</span></div>
    <div class="pill"><small>Night</small><span id="nightText">0/7</span></div>

    <div class="pill"><small>Fails</small><span id="failsText">0/3</span></div>
    <div class="pill"><small>Timer</small><span id="timerText">‚Äî</span></div>
    <div class="pill"><small>Power</small><span id="powerText">3</span></div>

    <div class="pill"><small>Mission</small><span id="missionText">‚Äî</span></div>
    <div class="pill"><small>Event</small><span id="eventText">‚Äî</span></div>
    <div class="pill"><small>Supply</small><span id="supplyText">3</span></div>

    <div class="pill"><small>Shield</small><span id="shieldText">‚Äî</span></div>
    <div class="pill"><small>Hearts</small><span id="myHeartsText">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    <div class="pill"><small>Players</small><span id="playersText">1/4</span></div>
  </div>

  <!-- Feed + Audio -->
  <div class="panel feed">
    <div class="feedHead">
      <div style="font-weight:900;">Room Feed</div>
      <div class="sp"></div>

      <button id="soundBtn" class="btn btnGold" style="padding:10px 14px; font-size:14px;">Sound</button>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.55" style="width:140px;" />
    </div>
    <div id="feedBox" class="feedBox"></div>
  </div>

  <!-- Night card -->
  <div id="nightPanel" class="panel nightWrap">
    <div class="nightHeader">
      <h3>Night Card (3 sec)</h3>
      <div class="tag" id="nightBadge">Waiting‚Ä¶</div>
    </div>
    <div id="nightCard" class="nightCard">
      <div>
        <div id="nightMain">‚Äî</div>
        <div class="sub" id="nightSub">Challenger picks a challenge</div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div id="controls" class="panel controls">
    <button id="inventoryBtn" class="btn btnSoft">Inventory</button>
    <button id="craftBtn" class="btn btnSoft">Craft</button>

    <button id="tradeBtn" class="btn btnSoft">Trade</button>
    <button id="roleBtn" class="btn btnGold">Role Action</button>

    <button id="pleaseBtn" class="btn btnGold">Please</button>
    <button id="readyBtn" class="btn btnGreen">Ready</button>

    <button id="pickChallengeBtn" class="btn btnGreen">Pick Challenge</button>
    <button id="startNightBtn" class="btn btnRed">Start Night</button>
  </div>
</div>

<!-- INVENTORY MODAL -->
<div id="invOverlay" class="overlay">
  <div class="modal">
    <h2>Inventory</h2>
    <div class="hint">Tap an item to use it (demo). Inventory syncs to Firebase.</div>

    <div class="row">
      <select id="addItemSelect" class="sp"></select>
      <button id="addItemBtn" class="btn btnGold">Add</button>
    </div>

    <div id="invList" class="modalList"></div>

    <div class="row">
      <div class="sp"></div>
      <button class="btn btnSoft" onclick="closeOverlay('invOverlay')">Close</button>
    </div>
  </div>
</div>

<!-- TRADE MODAL (dropdowns, no typing) -->
<div id="tradeOverlay" class="overlay">
  <div class="modal">
    <h2>Trade</h2>
    <div class="hint">Choose what you give, who you trade with, and what you want.</div>

    <div class="modalGrid">
      <div>
        <label>You give</label>
        <select id="tradeGive"></select>
      </div>
      <div>
        <label>To player</label>
        <select id="tradeTo"></select>
      </div>
      <div>
        <label>You want</label>
        <select id="tradeWant"></select>
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="sendTradeBtn" class="btn btnGold" style="width:100%;">Send Trade</button>
      </div>
    </div>

    <div style="font-weight:900;">Incoming trades</div>
    <div id="tradeInbox" class="modalList"></div>

    <div class="row">
      <div class="sp"></div>
      <button class="btn btnSoft" onclick="closeOverlay('tradeOverlay')">Close</button>
    </div>
  </div>
</div>

<!-- PLEASE MODAL -->
<div id="pleaseOverlay" class="overlay">
  <div class="modal">
    <h2>Please</h2>
    <div class="hint">
      Survivors can request help. Challenger sets the cost (Supply 1‚Äì2) and approves/denies.
    </div>

    <!-- Challenger controls -->
    <div id="pleaseChControls" class="panel" style="padding:10px; display:none;">
      <div class="row">
        <div class="sp">
          <div style="font-weight:900;">Challenger cost</div>
          <div class="hint" style="margin-top:2px;">Cost applies to all ‚ÄúPlease‚Äù requests.</div>
        </div>
        <select id="pleaseCostSelect" style="width:120px;">
          <option value="1">1 Supply</option>
          <option value="2">2 Supply</option>
        </select>
        <button id="saveCostBtn" class="btn btnGold" style="padding:10px 14px; font-size:14px;">Save</button>
      </div>

      <div style="height:8px;"></div>
      <div style="font-weight:900;">Requests</div>
      <div id="pleaseQueue" class="modalList"></div>
    </div>

    <!-- Survivor actions -->
    <div id="pleaseSvControls" class="panel" style="padding:10px; display:none;">
      <div class="hint">Pick one option:</div>
      <div class="modalGrid">
        <button id="pleaseItemBtn" class="btn btnGold">Request Item</button>
        <button id="pleaseHealBtn" class="btn btnGreen">Request Heal</button>
        <button id="pleaseSkipBtn" class="btn btnSoft">Skip Fail</button>
      </div>
      <div class="hint" style="margin-top:8px;">
        Cost is set by the Challenger (1‚Äì2 Supply).
      </div>
    </div>

    <div class="row">
      <div class="sp"></div>
      <button class="btn btnSoft" onclick="closeOverlay('pleaseOverlay')">Close</button>
    </div>
  </div>
</div>

<!-- CHALLENGE PICK MODAL -->
<div id="challengeOverlay" class="overlay">
  <div class="modal">
    <h2>Pick Challenge</h2>
    <div class="hint">Challenger selects a challenge card for the night.</div>

    <div id="challengeList" class="modalList"></div>

    <div class="row">
      <div class="sp"></div>
      <button class="btn btnSoft" onclick="closeOverlay('challengeOverlay')">Close</button>
    </div>
  </div>
</div>

<!-- WIN/LOSE OVERLAY (video optional) -->
<div id="endOverlay" class="overlay">
  <div class="modal" style="align-items:center;text-align:center;">
    <h2 id="endTitle">Game Over</h2>
    <div id="endText" class="hint" style="font-size:14px;"></div>

    <video id="endVideo" controls playsinline style="display:none; width:100%; border-radius:14px; border:1px solid rgba(0,0,0,.18);"></video>

    <div class="row" style="width:100%;">
      <button class="btn btnSoft sp" onclick="location.reload()">Reload</button>
      <button class="btn btnGold sp" onclick="closeOverlay('endOverlay')">Close</button>
    </div>
  </div>
</div>

<audio id="bgm" preload="auto" loop></audio>

<script>
/* ============================
   Firebase config (YOUR PROJECT)
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyD6T_zbq3-fhN10aCF9zZtWJxV0eMg8fZQ",
  authDomain: "survivalchallengedt.firebaseapp.com",
  databaseURL: "https://survivalchallengedt-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "survivalchallengedt",
  storageBucket: "survivalchallengedt.firebasestorage.app",
  messagingSenderId: "953781088335",
  appId: "1:953781088335:web:fc26e2fb17717004eeba3a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============================
   Helpers
   ============================ */
const $ = (id)=>document.getElementById(id);
function openOverlay(id){ $(id).style.display="flex"; }
function closeOverlay(id){ $(id).style.display="none"; }

function now(){ return Date.now(); }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function safeRoom(code){ return (code||"").replace(/[^A-Z0-9]/g,"").slice(0,6); }

function pushFeed(text){
  if(!currentRoom) return;
  const ref = db.ref(`rooms/${currentRoom}/feed`).push();
  ref.set({ t: text, ts: now() });
}

function heartsToText(h){ return "‚ù§Ô∏è".repeat(clamp(h||0,0,10)) || "‚Äî"; }

/* ============================
   Game data / items
   ============================ */
const ITEM_DEFS = [
  { id:"rope", name:"Rope", icon:"ü™¢" },
  { id:"torch", name:"Torch", icon:"üî•" },
  { id:"berries", name:"Berries", icon:"üçì" },
  { id:"trap", name:"Trap", icon:"ü™§" },
  { id:"water", name:"Water", icon:"üíß" },
  { id:"bandage", name:"Bandage", icon:"ü©π" },
  { id:"wood", name:"Wood", icon:"ü™µ" },
  { id:"stone", name:"Stone", icon:"ü™®" }
];

const START_INV = ["rope","berries","torch"]; // survivors start
const START_INV_CH = ["wood","stone"];        // challenger start (optional)

const CHALLENGES = [
  { id:"bear", title:"Bear", text:"A bear is nearby. Choose: hide or distract.", diff:2 },
  { id:"storm", title:"Storm", text:"A storm hits. Secure shelter fast.", diff:1 },
  { id:"snake", title:"Snake", text:"A snake bites. Needs help or cure.", diff:2 },
  { id:"cold", title:"Cold Night", text:"Temperature drops. Spend resources or suffer.", diff:1 },
  { id:"lost", title:"Lost Path", text:"Find the route back before dark.", diff:2 }
];

const MISSIONS = ["Find Food","Build Shelter","Make Fire","Collect Water","Craft Tools"];
const EVENTS = ["Quiet", "Windy", "Fog", "Lucky Find", "Bad Omen"];

/* ============================
   Multiplayer state
   ============================ */
let myId = localStorage.getItem("sc_id");
if(!myId){
  myId = Math.random().toString(36).slice(2,10);
  localStorage.setItem("sc_id", myId);
}

let currentRoom = null;
let myName = null;
let isChallenger = false;
let roomUnsub = null;
let feedUnsub = null;

let localRoom = null;

function showGame(){
  $("startScreen").style.display="none";
  $("gameScreen").style.display="flex";
}

function setNightCard(main, sub, pulse=false){
  $("nightMain").textContent = main || "‚Äî";
  $("nightSub").textContent = sub || "";
  $("nightCard").classList.toggle("pulse", !!pulse);
}

function setBadge(text){
  $("nightBadge").textContent = text || "‚Äî";
}

/* ============================
   Audio
   ============================ */
const bgm = $("bgm");
bgm.src = "assets/survival.mp3"; // place this file in /assets/survival.mp3
bgm.volume = parseFloat($("vol").value);

$("vol").addEventListener("input", ()=>{
  bgm.volume = parseFloat($("vol").value);
});

$("soundBtn").onclick = async ()=>{
  if(!isChallenger){
    alert("Only Challenger can control sound.");
    return;
  }
  try{
    if(bgm.paused){
      await bgm.play();
      $("soundBtn").textContent = "Sound On";
    }else{
      bgm.pause();
      $("soundBtn").textContent = "Sound";
    }
  }catch(e){
    alert("Audio blocked by browser. Tap any button first, then try again.");
  }
};

/* ============================
   UI actions
   ============================ */
$("inventoryBtn").onclick = ()=> openInventory();
$("craftBtn").onclick = ()=> alert("Craft: demo placeholder (next upgrade).");
$("roleBtn").onclick = ()=> roleAction();
$("tradeBtn").onclick = ()=> openTrade();
$("pleaseBtn").onclick = ()=> openPlease();
$("pickChallengeBtn").onclick = ()=> openChallengePick();
$("readyBtn").onclick = ()=> toggleReady();
$("startNightBtn").onclick = ()=> startNight();

/* ============================
   Join/Create
   ============================ */
$("joinBtn").onclick = async ()=>{
  const code = safeRoom($("roomInput").value.trim().toUpperCase());
  if(!code) return alert("Enter room code e.g. ABCD12");
  myName = ($("nameInput").value.trim() || ("Player-"+myId.slice(0,4))).slice(0,14);

  await joinRoom(code, myName);
};

async function joinRoom(code, name){
  currentRoom = code;
  const roomRef = db.ref(`rooms/${currentRoom}`);
  const snap = await roomRef.get();

  if(!snap.exists()){
    await roomRef.set({
      createdAt: now(),
      maxPlayers: 4,
      phase: "lobby",
      night: 0,
      nightsMax: 7,
      failsMax: 3,
      supply: 3,
      pleaseCost: 1,
      challengerId: myId,
      currentChallenge: null,
      currentChallengeText: null,
      mission: MISSIONS[Math.floor(Math.random()*MISSIONS.length)],
      event: EVENTS[Math.floor(Math.random()*EVENTS.length)],
      timer: null,
      ended: null,
      players: {}
    });
  }

  const room = (await roomRef.get()).val();
  isChallenger = room.challengerId === myId;

  const playersCount = room.players ? Object.keys(room.players).length : 0;
  if(playersCount >= 4 && !room.players?.[myId]){
    alert("Room is full (max 4).");
    currentRoom = null;
    return;
  }

  const base = {
    id: myId,
    name,
    role: isChallenger ? "Challenger" : "Survivor",
    hearts: 3,
    hunger: isChallenger ? null : 70,
    ready: false,
    fails: 0,
    power: isChallenger ? 3 : 0,
    inventory: {},
    joinedAt: now()
  };

  const startInv = isChallenger ? START_INV_CH : START_INV;
  const invObj = {};
  startInv.forEach(k => invObj[k] = (invObj[k] || 0) + 1);
  base.inventory = invObj;

  await db.ref(`rooms/${currentRoom}/players/${myId}`).set(base);

  // Remove player on disconnect
  db.ref(`rooms/${currentRoom}/players/${myId}`).onDisconnect().remove();

  pushFeed(`${name} joined as ${base.role}.`);

  showGame();
  startListeners();
}

/* ============================
   Listeners
   ============================ */
function startListeners(){
  if(roomUnsub) roomUnsub.off();
  if(feedUnsub) feedUnsub.off();

  const roomRef = db.ref(`rooms/${currentRoom}`);
  roomUnsub = roomRef;

  roomRef.on("value", (snap)=>{
    const data = snap.val();
    if(!data) return;
    localRoom = data;
    renderRoom(data);
    checkWinLose(data);
  });

  const feedRef = db.ref(`rooms/${currentRoom}/feed`).limitToLast(30);
  feedUnsub = feedRef;

  feedRef.on("value", (snap)=>{
    const obj = snap.val() || {};
    const items = Object.values(obj).sort((a,b)=>a.ts-b.ts);
    const box = $("feedBox");
    box.innerHTML = "";
    for(const it of items){
      const div = document.createElement("div");
      div.className = "feedItem";
      div.textContent = it.t;
      box.appendChild(div);
    }
    box.scrollTop = box.scrollHeight;
  });
}

function renderRoom(r){
  const me = r.players?.[myId];
  const count = r.players ? Object.keys(r.players).length : 1;

  $("phaseText").textContent = r.phase || "‚Äî";
  $("roleText").textContent = me?.role || (isChallenger ? "Challenger" : "Survivor");
  $("nightText").textContent = `${r.night||0}/${r.nightsMax||7}`;
  $("failsText").textContent = `${me?.fails||0}/${r.failsMax||3}`;
  $("timerText").textContent = r.timer ? `${r.timer}s` : "‚Äî";
  $("missionText").textContent = r.mission || "‚Äî";
  $("eventText").textContent = r.event || "‚Äî";
  $("powerText").textContent = (me?.power ?? (isChallenger?3:0));
  $("supplyText").textContent = (r.supply ?? 0);
  $("shieldText").textContent = me?.shield ? "ON" : "‚Äî";
  $("myHeartsText").textContent = heartsToText(me?.hearts||0);
  $("playersText").textContent = `${count}/4`;

  // Enable/disable buttons based on role
  $("pickChallengeBtn").disabled = !isChallenger;
  $("startNightBtn").disabled = !isChallenger;
  $("soundBtn").disabled = !isChallenger;

  // Night card content
  if(r.currentChallengeText){
    setBadge("Challenge ready");
    setNightCard(r.currentChallengeText, "Starts when Challenger presses Start Night", true);
  }else{
    setBadge(r.phase === "lobby" ? "Lobby" : "Waiting‚Ä¶");
    setNightCard("‚Äî", isChallenger ? "Pick a challenge" : "Wait for Challenger", false);
  }

  // Update inventory modal if open
  if($("invOverlay").style.display === "flex"){
    renderInventory(me?.inventory || {});
  }

  // Update trade modal if open
  if($("tradeOverlay").style.display === "flex"){
    renderTradeUI();
  }

  // Update please modal if open
  if($("pleaseOverlay").style.display === "flex"){
    renderPleaseUI();
  }

  // Buttons feel alive (but some locked)
  $("inventoryBtn").disabled = false;
  $("tradeBtn").disabled = false;
  $("pleaseBtn").disabled = false;
  $("craftBtn").disabled = false;
  $("roleBtn").disabled = false;

  // Challenger: no hunger, Survivors: hunger shown via HUD? (we do not show hunger in HUD here; add later if you want)
}

/* ============================
   Inventory
   ============================ */
function openInventory(){
  const me = localRoom?.players?.[myId];
  if(!me) return;

  // Fill add dropdown
  $("addItemSelect").innerHTML = "";
  for(const it of ITEM_DEFS){
    const opt = document.createElement("option");
    opt.value = it.id;
    opt.textContent = `${it.icon} ${it.name}`;
    $("addItemSelect").appendChild(opt);
  }

  renderInventory(me.inventory || {});
  openOverlay("invOverlay");
}

function renderInventory(inv){
  const box = $("invList");
  box.innerHTML = "";

  const entries = Object.entries(inv||{}).filter(([k,v])=>v>0);
  if(entries.length === 0){
    box.textContent = "Empty inventory.";
    return;
  }

  for(const [id, qty] of entries){
    const def = ITEM_DEFS.find(x=>x.id===id) || {name:id, icon:"üì¶"};
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `<span>${def.icon} ${def.name} <span style="opacity:.7;">x${qty}</span></span>
                     <button class="btn btnSoft" style="padding:8px 10px; font-size:12px;">Use</button>`;
    row.querySelector("button").onclick = ()=> {
      alert(`Used: ${def.name} (demo)`);
    };
    box.appendChild(row);
  }
}

$("addItemBtn").onclick = async ()=>{
  if(!currentRoom) return;
  const id = $("addItemSelect").value;
  const path = `rooms/${currentRoom}/players/${myId}/inventory/${id}`;
  const snap = await db.ref(path).get();
  const cur = snap.val() || 0;
  await db.ref(path).set(cur + 1);
  pushFeed(`${myName} obtained ${ITEM_DEFS.find(x=>x.id===id)?.name || id}.`);
};

/* ============================
   Trade (dropdowns)
   ============================ */
function openTrade(){
  renderTradeUI();
  openOverlay("tradeOverlay");
}

function renderTradeUI(){
  const r = localRoom;
  if(!r) return;

  const me = r.players?.[myId];
  const inv = me?.inventory || {};

  // Give dropdown: only items you have
  const giveSel = $("tradeGive");
  giveSel.innerHTML = "";
  const have = Object.entries(inv).filter(([k,v])=>v>0);
  if(have.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No items";
    giveSel.appendChild(opt);
  } else {
    for(const [id, qty] of have){
      const def = ITEM_DEFS.find(x=>x.id===id) || {name:id, icon:"üì¶"};
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = `${def.icon} ${def.name} (x${qty})`;
      giveSel.appendChild(opt);
    }
  }

  // Want dropdown: all items
  const wantSel = $("tradeWant");
  wantSel.innerHTML = "";
  for(const it of ITEM_DEFS){
    const opt = document.createElement("option");
    opt.value = it.id;
    opt.textContent = `${it.icon} ${it.name}`;
    wantSel.appendChild(opt);
  }

  // To dropdown: other players
  const toSel = $("tradeTo");
  toSel.innerHTML = "";
  const others = Object.values(r.players||{}).filter(p=>p.id !== myId);
  if(others.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No other players";
    toSel.appendChild(opt);
  } else {
    for(const p of others){
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.name} (${p.role})`;
      toSel.appendChild(opt);
    }
  }

  // Inbox
  const inbox = $("tradeInbox");
  inbox.innerHTML = "";
  const incoming = r.trades ? Object.values(r.trades).filter(t=>t.to===myId) : [];
  if(incoming.length === 0){
    inbox.textContent = "No incoming trades.";
  } else {
    for(const t of incoming.sort((a,b)=>a.ts-b.ts)){
      const from = r.players?.[t.from]?.name || t.from;
      const giveDef = ITEM_DEFS.find(x=>x.id===t.give) || {name:t.give, icon:"üì¶"};
      const wantDef = ITEM_DEFS.find(x=>x.id===t.want) || {name:t.want, icon:"üì¶"};

      const row = document.createElement("div");
      row.className = "listRow";
      row.innerHTML = `
        <span><b>${from}</b> offers ${giveDef.icon} ${giveDef.name} for ${wantDef.icon} ${wantDef.name}</span>
        <span style="display:flex; gap:8px;">
          <button class="btn btnGreen" style="padding:8px 10px; font-size:12px;">Accept</button>
          <button class="btn btnRed" style="padding:8px 10px; font-size:12px;">Decline</button>
        </span>
      `;
      const [acc, dec] = row.querySelectorAll("button");
      acc.onclick = ()=> acceptTrade(t);
      dec.onclick = ()=> declineTrade(t);
      inbox.appendChild(row);
    }
  }
}

$("sendTradeBtn").onclick = async ()=>{
  const r = localRoom;
  const give = $("tradeGive").value;
  const to = $("tradeTo").value;
  const want = $("tradeWant").value;

  if(!give) return alert("You have no items to give.");
  if(!to) return alert("No target player.");
  if(!want) return alert("Pick what you want.");

  const me = r.players?.[myId];
  if(!me?.inventory?.[give] || me.inventory[give] <= 0) return alert("You do not have that item.");

  const tradeRef = db.ref(`rooms/${currentRoom}/trades`).push();
  await tradeRef.set({ id: tradeRef.key, from: myId, to, give, want, ts: now() });
  pushFeed(`${myName} sent a trade.`);
};

async function acceptTrade(t){
  const r = localRoom;
  const me = r.players?.[myId];
  const fromP = r.players?.[t.from];
  if(!me || !fromP) return;

  // check you have the wanted item to pay
  const youPay = t.want;
  if(!me.inventory?.[youPay] || me.inventory[youPay] <= 0){
    alert("You don't have the requested item.");
    return;
  }

  // check sender still has the give item
  if(!fromP.inventory?.[t.give] || fromP.inventory[t.give] <= 0){
    alert("Sender no longer has that item.");
    return;
  }

  const updates = {};
  updates[`rooms/${currentRoom}/players/${t.from}/inventory/${t.give}`] = fromP.inventory[t.give] - 1;
  updates[`rooms/${currentRoom}/players/${myId}/inventory/${t.give}`] = (me.inventory[t.give]||0) + 1;

  updates[`rooms/${currentRoom}/players/${myId}/inventory/${youPay}`] = me.inventory[youPay] - 1;
  updates[`rooms/${currentRoom}/players/${t.from}/inventory/${youPay}`] = (fromP.inventory[youPay]||0) + 1;

  updates[`rooms/${currentRoom}/trades/${t.id}`] = null;

  await db.ref().update(updates);
  pushFeed(`${me.name} accepted a trade from ${fromP.name}.`);
}

async function declineTrade(t){
  await db.ref(`rooms/${currentRoom}/trades/${t.id}`).remove();
  pushFeed(`${myName} declined a trade.`);
}

/* ============================
   Ready / Night flow
   ============================ */
async function toggleReady(){
  const me = localRoom?.players?.[myId];
  if(!me) return;
  await db.ref(`rooms/${currentRoom}/players/${myId}/ready`).set(!me.ready);
  pushFeed(`${myName} is ${!me.ready ? "ready" : "not ready"}.`);
}

async function openChallengePick(){
  if(!isChallenger) return alert("Only Challenger can pick challenge.");
  const list = $("challengeList");
  list.innerHTML = "";

  for(const c of CHALLENGES){
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <span><b>${c.title}</b> <span style="opacity:.7;">(diff ${c.diff})</span><br><span style="opacity:.75;font-weight:700;">${c.text}</span></span>
      <button class="btn btnGold" style="padding:8px 10px; font-size:12px;">Pick</button>
    `;
    row.querySelector("button").onclick = async ()=>{
      await db.ref(`rooms/${currentRoom}/currentChallenge`).set(c.id);
      await db.ref(`rooms/${currentRoom}/currentChallengeText`).set(`${c.title}: ${c.text}`);
      pushFeed(`Challenger picked: ${c.title}.`);
      closeOverlay("challengeOverlay");
    };
    list.appendChild(row);
  }

  openOverlay("challengeOverlay");
}

async function startNight(){
  if(!isChallenger) return;

  const r = localRoom;
  if(!r.currentChallengeText){
    alert("Pick a challenge first.");
    return;
  }

  // require at least 2 players for meaningful round (you can change this)
  const count = r.players ? Object.keys(r.players).length : 1;
  if(count < 2){
    alert("Need at least 2 players.");
    return;
  }

  // everyone must be ready except challenger
  const players = Object.values(r.players||{});
  const survivors = players.filter(p=>p.role==="Survivor");
  const allReady = survivors.every(p=>p.ready);
  if(!allReady){
    alert("Not all Survivors are ready.");
    return;
  }

  const nextNight = (r.night||0) + 1;

  // reset readies, random mission/event
  const updates = {};
  for(const p of players){
    updates[`rooms/${currentRoom}/players/${p.id}/ready`] = false;
    updates[`rooms/${currentRoom}/players/${p.id}/skipFailUsed`] = false;
  }

  updates[`rooms/${currentRoom}/phase`] = "night";
  updates[`rooms/${currentRoom}/night`] = nextNight;
  updates[`rooms/${currentRoom}/mission`] = MISSIONS[Math.floor(Math.random()*MISSIONS.length)];
  updates[`rooms/${currentRoom}/event`] = EVENTS[Math.floor(Math.random()*EVENTS.length)];

  await db.ref().update(updates);

  // Show card 3 sec for everyone (client UI uses currentChallengeText)
  setNightCard(r.currentChallengeText, "Night started‚Ä¶", true);
  setBadge("Night running");

  pushFeed(`Night ${nextNight} started.`);

  // simple auto-resolution after 6 seconds: random fails for survivors (demo)
  setTimeout(async ()=>{
    const rr = (await db.ref(`rooms/${currentRoom}`).get()).val();
    if(!rr || rr.phase !== "night") return;

    const ps = Object.values(rr.players||{});
    const svs = ps.filter(p=>p.role==="Survivor");

    const up = {};
    for(const s of svs){
      // if player used Skip Fail, they avoid 1 fail (handled by request approve)
      // random: 35% chance of fail per night
      const fail = Math.random() < 0.35;
      if(fail){
        const newFails = (s.fails||0) + 1;
        up[`rooms/${currentRoom}/players/${s.id}/fails`] = newFails;
        if(newFails >= (rr.failsMax||3)){
          // lose a heart when max fails hit, then reset fails
          const newHearts = (s.hearts||0) - 1;
          up[`rooms/${currentRoom}/players/${s.id}/hearts`] = newHearts;
          up[`rooms/${currentRoom}/players/${s.id}/fails`] = 0;
        }
      }
    }

    // clear current challenge for next pick
    up[`rooms/${currentRoom}/currentChallenge`] = null;
    up[`rooms/${currentRoom}/currentChallengeText`] = null;
    up[`rooms/${currentRoom}/phase`] = "lobby";

    await db.ref().update(up);
    pushFeed(`Night ${rr.night} ended.`);
    setBadge("Lobby");
    setNightCard("‚Äî", isChallenger ? "Pick a challenge" : "Wait for Challenger", false);
  }, 6000);
}

/* ============================
   Role Action (simple demo)
   ============================ */
async function roleAction(){
  const r = localRoom;
  const me = r?.players?.[myId];
  if(!me) return;

  if(me.role === "Challenger"){
    // spend 1 power to gain 1 supply
    if((me.power||0) <= 0) return alert("No Power left.");
    const supply = (r.supply||0) + 1;
    await db.ref().update({
      [`rooms/${currentRoom}/players/${myId}/power`]: (me.power||0) - 1,
      [`rooms/${currentRoom}/supply`]: supply
    });
    pushFeed("Challenger used Power ‚Üí +1 Supply.");
  } else {
    // survivor: small self-help, 1 per lobby: +1 hunger (not shown) or +small bonus
    alert("Survivor role action: placeholder (next upgrade).");
  }
}

/* ============================
   PLEASE system (UPGRADE)
   - 3 options: item / heal / skip fail
   - challenger sets cost 1-2 supply
   - challenger approves/denies
   ============================ */
function openPlease(){
  renderPleaseUI();
  openOverlay("pleaseOverlay");
}

function renderPleaseUI(){
  const r = localRoom;
  if(!r) return;

  const me = r.players?.[myId];
  const cost = r.pleaseCost || 1;

  $("pleaseChControls").style.display = isChallenger ? "block" : "none";
  $("pleaseSvControls").style.display = !isChallenger ? "block" : "none";

  if(isChallenger){
    $("pleaseCostSelect").value = String(cost);
    renderPleaseQueue();
  }
}

$("saveCostBtn").onclick = async ()=>{
  if(!isChallenger) return;
  const v = parseInt($("pleaseCostSelect").value,10) || 1;
  await db.ref(`rooms/${currentRoom}/pleaseCost`).set(clamp(v,1,2));
  pushFeed(`Challenger set Please cost to ${v} Supply.`);
};

$("pleaseItemBtn").onclick = ()=> sendPleaseRequest("item");
$("pleaseHealBtn").onclick = ()=> sendPleaseRequest("heal");
$("pleaseSkipBtn").onclick = ()=> sendPleaseRequest("skip");

async function sendPleaseRequest(type){
  const r = localRoom;
  const me = r?.players?.[myId];
  if(!me || isChallenger) return;

  const reqRef = db.ref(`rooms/${currentRoom}/pleaseRequests/${myId}`);
  const existing = (await reqRef.get()).val();
  if(existing && existing.status === "pending"){
    alert("You already have a pending request.");
    return;
  }

  await reqRef.set({
    from: myId,
    name: me.name,
    type,
    status: "pending",
    ts: now()
  });

  pushFeed(`${me.name} asked: Please (${type}).`);
  alert("Request sent. Challenger must approve.");
}

async function renderPleaseQueue(){
  const r = localRoom;
  const cost = r.pleaseCost || 1;
  const q = r.pleaseRequests || {};
  const list = $("pleaseQueue");
  list.innerHTML = "";

  const arr = Object.values(q).filter(x=>x.status==="pending").sort((a,b)=>a.ts-b.ts);
  if(arr.length === 0){
    list.textContent = "No requests.";
    return;
  }

  for(const req of arr){
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <span><b>${req.name}</b> ‚Üí <span class="tag">${req.type.toUpperCase()}</span> <span style="opacity:.7;">(cost ${cost})</span></span>
      <span style="display:flex; gap:8px;">
        <button class="btn btnGreen" style="padding:8px 10px; font-size:12px;">Approve</button>
        <button class="btn btnRed" style="padding:8px 10px; font-size:12px;">Deny</button>
      </span>
    `;
    const [ap, dn] = row.querySelectorAll("button");
    ap.onclick = ()=> approvePlease(req.from);
    dn.onclick = ()=> denyPlease(req.from);
    list.appendChild(row);
  }
}

async function approvePlease(playerId){
  const r = localRoom;
  const cost = r.pleaseCost || 1;
  const supply = r.supply || 0;

  if(supply < cost){
    alert("Not enough Supply.");
    return;
  }

  const reqSnap = await db.ref(`rooms/${currentRoom}/pleaseRequests/${playerId}`).get();
  const req = reqSnap.val();
  if(!req || req.status !== "pending") return;

  const p = r.players?.[playerId];
  if(!p) return;

  const updates = {};
  updates[`rooms/${currentRoom}/supply`] = supply - cost;
  updates[`rooms/${currentRoom}/pleaseRequests/${playerId}/status`] = "approved";

  if(req.type === "heal"){
    const newHearts = clamp((p.hearts||0) + 1, 0, 5);
    updates[`rooms/${currentRoom}/players/${playerId}/hearts`] = newHearts;
  }
  else if(req.type === "item"){
    // give random item
    const it = ITEM_DEFS[Math.floor(Math.random()*ITEM_DEFS.length)];
    const cur = (p.inventory?.[it.id] || 0) + 1;
    updates[`rooms/${currentRoom}/players/${playerId}/inventory/${it.id}`] = cur;
  }
  else if(req.type === "skip"){
    // reduce fails by 1 (minimum 0)
    const newFails = clamp((p.fails||0) - 1, 0, 99);
    updates[`rooms/${currentRoom}/players/${playerId}/fails`] = newFails;
    updates[`rooms/${currentRoom}/players/${playerId}/skipFailUsed`] = true;
  }

  await db.ref().update(updates);
  pushFeed(`Challenger approved Please for ${p.name} (${req.type}).`);
  renderPleaseQueue();
}

async function denyPlease(playerId){
  const r = localRoom;
  const p = r.players?.[playerId];
  await db.ref(`rooms/${currentRoom}/pleaseRequests/${playerId}`).update({ status: "denied" });
  pushFeed(`Challenger denied Please for ${p?.name || playerId}.`);
  renderPleaseQueue();
}

/* ============================
   Win/Lose (basic)
   - Survivors win if night reaches 7 and at least one survivor has hearts > 0
   - Challenger wins if all survivors hearts <= 0
   ============================ */
async function checkWinLose(r){
  if(r.ended) return;

  const ps = Object.values(r.players||{});
  const svs = ps.filter(p=>p.role==="Survivor");
  if(svs.length === 0) return;

  const alive = svs.some(p=>(p.hearts||0) > 0);

  // Challenger win
  if(!alive){
    await endGame("Challenger wins!", "All Survivors lost their hearts.", "assets/win-challenger.mp4");
    return;
  }

  // Survivors win after 7 nights (if alive)
  if((r.night||0) >= (r.nightsMax||7)){
    await endGame("Survivors win!", "You survived 7 nights.", "assets/win-survivors.mp4");
    return;
  }
}

async function endGame(title, text, videoPath){
  // mark ended in DB once (challenger writes, but allow anyone)
  try{
    await db.ref(`rooms/${currentRoom}/ended`).transaction(cur => cur || { title, text, at: now(), video: videoPath||null });
  }catch(e){}

  $("endTitle").textContent = title;
  $("endText").textContent = text;

  const v = $("endVideo");
  if(videoPath){
    v.src = videoPath; // optional: put file in assets/
    v.style.display = "block";
  } else {
    v.style.display = "none";
  }

  openOverlay("endOverlay");
}

/* ============================
   Auto-show end overlay if ended
   ============================ */
db.ref().on("value", ()=>{}); // keep firebase warm (no-op)

/* ============================
   If user opens with ?room=XXXXXX
   ============================ */
(function initFromUrl(){
  const u = new URL(location.href);
  const rr = safeRoom((u.searchParams.get("room")||"").toUpperCase());
  if(rr){
    $("roomInput").value = rr;
  }
})();
</script>

</body>
</html>
