<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Survival Challenge</title>

  <!-- Firebase compat (works in plain HTML on GitHub Pages) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --ink:#2b1d0e;
      --shadow: rgba(0,0,0,.28);
      --stroke: rgba(0,0,0,.18);
      --paperBg: rgba(255,255,255,.86);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      overflow:hidden;
      background: url("assets/wood.png") center/cover no-repeat fixed;
    }
    @media (max-width: 768px){ body{ background-attachment: scroll; } }

    /* vignette */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(1200px 700px at 50% 10%, rgba(255,255,255,.10), transparent 62%),
        radial-gradient(900px 600px at 15% 0%, rgba(255,255,255,.06), transparent 56%),
        radial-gradient(900px 600px at 90% 20%, rgba(0,0,0,.22), transparent 64%);
    }

    .screen{
      position:fixed; inset:0;
      padding: calc(10px + var(--safeTop)) 10px calc(10px + var(--safeBottom)) 10px;
      display:none;
      gap:10px;
    }
    .screen.active{ display:flex; flex-direction:column; }

    .paper{
      background:
        url("assets/paper.png") center/cover no-repeat,
        var(--paperBg);
      border: 1px solid var(--stroke);
      border-radius:18px;
      box-shadow: 0 14px 28px var(--shadow);
      backdrop-filter: blur(8px);
    }

    /* Start screen */
    .startWrap{
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:12px;
      padding:18px;
    }
    #logo{
      width:min(420px, 86vw);
      height:auto;
      display:block;
      filter: drop-shadow(0 16px 22px rgba(0,0,0,.35));
    }
    .byline{
      margin-top:4px;
      font-weight:900;
      opacity:.85;
    }
    .startCard{
      width:min(560px, 96vw);
      padding:14px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .grid2{ grid-template-columns: 1fr; }
    }
    label{ font-size:13px; font-weight:900; opacity:.82; }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.16);
      background: rgba(255,255,255,.92);
      outline:none;
      font-size:16px;
    }

    /* Buttons */
    .btn{
      border:2px solid rgba(0,0,0,.22);
      border-radius:16px;
      padding:12px 14px;
      font-weight:950;
      font-size:16px;
      cursor:pointer;
      user-select:none;
      box-shadow:
        0 10px 0 rgba(0,0,0,.18),
        0 18px 26px rgba(0,0,0,.18);
      transition: transform .08s ease, filter .18s ease;
    }
    .btn:active{
      transform: translateY(2px) scale(.99);
      box-shadow:
        0 7px 0 rgba(0,0,0,.16),
        0 14px 18px rgba(0,0,0,.16);
    }
    .btn:disabled{ opacity:.55; filter: grayscale(.35); cursor:not-allowed; }
    .btnGold{ background: linear-gradient(#ffe7a2,#f0b347); color:#2a1b00; }
    .btnGreen{ background: linear-gradient(#66f09a,#1fb14a); color:#05240e; }
    .btnRed{ background: linear-gradient(#ff8d8d,#df3a3a); color:#2b0707; }
    .btnSoft{ background: linear-gradient(rgba(255,255,255,.92),rgba(245,245,245,.78)); color:#231a12; box-shadow:none; border:1px solid rgba(0,0,0,.16); }

    /* Game layout */
    .hud{
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 760px){
      .hud{ grid-template-columns: 1fr 1fr; }
    }
    .pill{
      min-height:48px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(0,0,0,.14);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight:950;
    }
    .pill small{ opacity:.72; font-weight:900; }

    .mainRow{
      display:flex;
      gap:10px;
      flex:1;
      min-height:0;
    }
    @media (max-width: 880px){
      .mainRow{ flex-direction:column; }
    }

    .feed{
      width:min(520px, 100%);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .feedTitle{ font-size:16px; font-weight:1000; }
    .feedBox{
      flex:1;
      min-height:120px;
      max-height:220px;
      overflow:auto;
      padding:10px;
      border-radius:14px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.14);
      font-size:14px;
      font-weight:850;
    }
    .feedItem{ padding:6px 0; border-bottom:1px dashed rgba(0,0,0,.14); }
    .feedItem:last-child{ border-bottom:0; }

    .cardArea{
      flex:1;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .cardHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,224,138,.65);
      border:1px solid rgba(0,0,0,.12);
      font-weight:1000;
      font-size:12px;
    }

    #nightCard{
      flex:1;
      min-height:220px;
      background: url("assets/card-frame.png") center/contain no-repeat;
      border:0;
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:44px 36px;
      box-shadow: 0 18px 34px rgba(0,0,0,.25);
      overflow:hidden;
      position:relative;
    }
    @media (max-width: 760px){
      #nightCard{ min-height:200px; padding:40px 28px; }
    }
    #nightMain{ font-size:26px; font-weight:1000; text-shadow:0 2px 0 rgba(0,0,0,.08); }
    #nightSub{ margin-top:6px; font-size:14px; font-weight:900; opacity:.85; }

    .pulse{ animation:pulse .9s ease-in-out infinite alternate; }
    @keyframes pulse{
      from{ filter:brightness(1); transform:translateY(0); }
      to{ filter:brightness(1.06); transform:translateY(-1px); }
    }

    .controls{
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      position:sticky;
      bottom:0;
      background:
        url("assets/paper.png") center/cover no-repeat,
        rgba(255,255,255,.80);
      border:1px solid rgba(0,0,0,.12);
      border-radius:18px;
      backdrop-filter: blur(10px);
    }

    /* Overlay modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.38);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .overlay.active{ display:flex; }
    .modal{
      width:min(620px, 96vw);
      max-height: 88svh;
      overflow:auto;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal h2{ margin:0; font-size:18px; font-weight:1000; }
    .hint{ font-size:13px; opacity:.82; font-weight:900; line-height:1.35; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1; min-width: 120px; }
    .list{
      background: rgba(255,255,255,.88);
      border:1px dashed rgba(0,0,0,.20);
      border-radius:14px;
      padding:10px;
    }
    .listRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:8px 0;
      border-bottom:1px dashed rgba(0,0,0,.16);
      font-size:14px;
      font-weight:950;
    }
    .listRow:last-child{ border-bottom:0; }

    /* tiny toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(16px + var(--safeBottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.75);
      color:white;
      padding:10px 14px;
      border-radius: 999px;
      font-weight:900;
      font-size:13px;
      display:none;
      z-index:10000;
    }
/* === MOBILE FIX: make Night Card + buttons always visible === */
@media (max-width: 880px){
  .mainRow{
    flex-direction: column;
    gap: 10px;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* Limit feed height so card area fits */
  .feed{
    width: 100%;
    flex: 0 0 auto;
    max-height: 210px;
    min-height: 160px;
  }
  .feedBox{ max-height: 150px; }

  /* Card area MUST be visible and fill the rest */
  .cardArea{
    flex: 1 1 auto;
    min-height: 0;
    overflow: hidden;
    display: flex;
  }

  /* Night card always takes space */
  #nightCard{
    flex: 1 1 auto;
    min-height: 180px;
  }

  /* Controls always visible at bottom */
  .controls{
    position: sticky;
    bottom: calc(8px + var(--safeBottom));
    z-index: 50;
  }
}

/* === EXTRA: allow page to scroll if needed === */
#gameScreen{
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

  </style>
</head>

<body>

  <!-- START -->
  <div id="startScreen" class="screen active">
    <div class="startWrap">
      <img id="logo" src="assets/logo.png" alt="Survival Challenge" onerror="this.style.display='none'">
      <div class="byline">(by David Toma)</div>

      <div class="startCard paper">
        <div class="grid2">
          <div>
            <label>Your name</label>
            <input id="nameInput" maxlength="14" placeholder="David" />
          </div>
          <div>
            <label>Room code (max 6)</label>
            <input id="roomInput" maxlength="6" placeholder="ABCD12" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="joinBtn" class="btn btnGreen">Join / Create</button>
          <button id="howBtn" class="btn btnGold">How it works</button>
        </div>

        <div class="hint" style="margin-top:8px;">
          Max 4 players. First player becomes <b>Challenger</b>.
        </div>

        <div class="hint" style="margin-top:8px;">
          <b>Opis (HR):</b> PreÅ¾ivite 7 noÄ‡i kao Survivori. Challenger zadaje izazove i upravlja resursima. PreviÅ¡e failova ili izgubljena srca = poraz.
          <br><br>
          <b>Description (EN):</b> Survive 7 nights as Survivors. The Challenger sets challenges and controls resources. Too many fails or hearts lost = defeat.
        </div>
      </div>
    </div>
  </div>

  <!-- GAME -->
  <div id="gameScreen" class="screen">
    <div id="hudPanel" class="paper hud">
      <div class="pill"><small>Phase</small><span id="hudPhase">lobby</span></div>
      <div class="pill"><small>Role</small><span id="hudRole">â€”</span></div>
      <div class="pill"><small>Night</small><span id="hudNight">0/7</span></div>

      <div class="pill"><small>Fails</small><span id="hudFails">0/3</span></div>
      <div class="pill"><small>Event</small><span id="hudEvent">â€”</span></div>
      <div class="pill"><small>Timer</small><span id="hudTimer">â€”</span></div>

      <div class="pill"><small>Supply</small><span id="hudSupply">â€”</span></div>
      <div class="pill"><small>Power</small><span id="hudPower">â€”</span></div>
      <div class="pill"><small>Hearts</small><span id="hudHearts">â€”</span></div>

      <div class="pill"><small>Hunger</small><span id="hudHunger">â€”</span></div>
      <div class="pill"><small>Players</small><span id="hudPlayers">0/4</span></div>
      <div class="pill"><small>Sound</small>
        <button id="soundBtn" class="btn btnSoft" style="padding:8px 10px; font-size:13px;">ðŸ”‡</button>
      </div>
    </div>

    <div class="mainRow">
      <div class="paper feed">
        <div class="feedTitle">Room Feed</div>
        <div class="feedBox" id="feedBox"></div>
      </div>

      <div class="paper cardArea">
        <div class="cardHeader">
          <div style="font-weight:1000;">Night Card</div>
          <div class="tag" id="roomCodeTag">ROOM: â€”</div>
        </div>

        <div id="nightCard">
          <div>
            <div id="nightMain">Waitingâ€¦</div>
            <div id="nightSub">Challenger starts the night</div>
          </div>
        </div>

        <div class="controls">
          <button id="inventoryBtn" class="btn btnGold">Inventory</button>
          <button id="tradeBtn" class="btn btnGold">Trade</button>
          <button id="pleaseBtn" class="btn btnGold">Please</button>
          <button id="readyBtn" class="btn btnGreen">Ready</button>
          <button id="pickChallengeBtn" class="btn btnGreen">Pick Challenge</button>
          <button id="startNightBtn" class="btn btnRed">Start Night</button>
        </div>

        <div class="hint" id="hintLine">Tip: Open Inventory and add / use items.</div>
      </div>
    </div>
  </div>

  <!-- AUDIO -->
  <audio id="bgMusic" loop>
    <source src="assets/survival.mp3" type="audio/mpeg">
  </audio>

  <!-- MODALS -->
  <div id="modalOverlay" class="overlay">
    <div id="modalBox" class="paper modal"></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  /* =========================
     1) FIREBASE CONFIG (YOUR PROJECT)
     ========================= */
  const firebaseConfig = {
    apiKey: "AIzaSyD6T_zbq3-fhN10aCF9zZtWJxV0eMg8fZQ",
    authDomain: "survivalchallengedt.firebaseapp.com",
    databaseURL: "https://survivalchallengedt-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "survivalchallengedt",
    storageBucket: "survivalchallengedt.firebasestorage.app",
    messagingSenderId: "953781088335",
    appId: "1:953781088335:web:fc26e2fb17717004eeba3a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /* =========================
     2) HELPERS
     ========================= */
  const $ = (id)=>document.getElementById(id);
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const now = ()=>Date.now();

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=>t.style.display="none", 1600);
  }

  function openModal(html){
    $("modalBox").innerHTML = html;
    $("modalOverlay").classList.add("active");
  }
  function closeModal(){
    $("modalOverlay").classList.remove("active");
    $("modalBox").innerHTML = "";
  }
  $("modalOverlay").addEventListener("click", (e)=>{
    if(e.target.id==="modalOverlay") closeModal();
  });

  function pushFeed(text){
    if(!currentRoom) return;
    const ref = db.ref(`rooms/${currentRoom}/feed`).push();
    ref.set({ t: now(), text });
  }

  function safeStr(s){ return (s||"").toString().trim(); }
  function roomCodeNormalize(s){
    return safeStr(s).toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6);
  }

  /* =========================
     3) GAME CONSTANTS
     ========================= */
  const MAX_PLAYERS = 4;
  const MAX_NIGHTS = 7;
  const MAX_FAILS = 3;

  const ITEM_CATALOG = [
    { key:"rope",   name:"Rope",   icon:"ðŸª¢" },
    { key:"torch",  name:"Torch",  icon:"ðŸ”¥" },
    { key:"berries",name:"Berries",icon:"ðŸ«" },
    { key:"trap",   name:"Trap",   icon:"ðŸª¤" },
    { key:"water",  name:"Water",  icon:"ðŸ’§" },
    { key:"medkit", name:"Medkit", icon:"ðŸ©¹" },
    { key:"wood",   name:"Wood",   icon:"ðŸªµ" }
  ];
  const START_ITEMS = { rope:1, torch:1, berries:2 };

  const EVENT_LIST = [
    { title:"Lucky Find", effect:"+1 supply", supplyDelta:+1 },
    { title:"Cold Wind", effect:"-10 hunger all", hungerDelta:-10 },
    { title:"Quiet Night", effect:"No effect", hungerDelta:0 },
    { title:"Rain", effect:"Torch less effective", tag:"rain" },
    { title:"Wolves Nearby", effect:"Challenge +1 difficulty", diffDelta:+1 }
  ];

  const CHALLENGES = [
    { title:"Make Fire", diff:3, hint:"Play Torch or team up." },
    { title:"Build Shelter", diff:4, hint:"Wood / Rope helps." },
    { title:"Find Food", diff:3, hint:"Berries / Trap helps." },
    { title:"Cross River", diff:4, hint:"Rope helps." },
    { title:"Treat Wounds", diff:3, hint:"Medkit helps." }
  ];

  function itemByKey(k){ return ITEM_CATALOG.find(x=>x.key===k); }
  function fmtInv(inv){
    const parts = [];
    for(const it of ITEM_CATALOG){
      const q = inv?.[it.key]||0;
      if(q>0) parts.push(`${it.icon} ${it.name} x${q}`);
    }
    return parts.length? parts.join(", ") : "Empty";
  }

  /* =========================
     4) PLAYER + ROOM STATE
     ========================= */
  let myId = localStorage.getItem("sc_myId");
  if(!myId){
    myId = Math.random().toString(36).slice(2,10);
    localStorage.setItem("sc_myId", myId);
  }

  let currentRoom = null;
  let isChallenger = false;
  let roomUnsub = null;
  let lastRoomData = null;

  const audio = $("bgMusic");
  let localSoundEnabled = false;

  function showScreen(which){
    $("startScreen").classList.remove("active");
    $("gameScreen").classList.remove("active");
    $(which).classList.add("active");
  }

  function setHint(text){
    $("hintLine").textContent = text || "";
  }

  /* =========================
     5) ROOM INIT / JOIN
     ========================= */
  async function joinOrCreate(){
    const name = safeStr($("nameInput").value) || ("Player-" + myId.slice(0,4));
    const code = roomCodeNormalize($("roomInput").value);
    if(!code) return toast("Enter room code.");

    currentRoom = code;
    $("roomCodeTag").textContent = "ROOM: " + code;

    const roomRef = db.ref(`rooms/${code}`);
    const snap = await roomRef.get();

    if(!snap.exists()){
      await roomRef.set({
        createdAt: now(),
        phase: "lobby",
        night: 0,
        fails: 0,
        challengerId: myId,
        supply: 4,
        power: 3,
        soundOn: false,
        event: null,
        currentChallenge: null,
        timerEndsAt: null,
        actions: {},
        pleaseRequests: {},
        tradeRequests: {},
        players: {}
      });
    }

    // load latest
    const room = (await roomRef.get()).val();

    // max players check (ignore if rejoin)
    const players = room.players || {};
    const count = Object.keys(players).length;
    if(!players[myId] && count >= MAX_PLAYERS){
      currentRoom = null;
      return alert("Room is full (max 4).");
    }

    isChallenger = (room.challengerId === myId);

    // set my player record
    const playerRef = db.ref(`rooms/${code}/players/${myId}`);
    const existing = (await playerRef.get()).val();

    const basePlayer = existing || {
      id: myId,
      name,
      role: isChallenger ? "Challenger" : "Survivor",
      hearts: isChallenger ? 3 : 3,
      hunger: isChallenger ? null : 70,
      ready: false,
      inventory: isChallenger ? {} : structuredClone(START_ITEMS)
    };

    // update name/role if needed
    basePlayer.name = name;
    basePlayer.role = isChallenger ? "Challenger" : "Survivor";
    await playerRef.set(basePlayer);

    // announce join
    pushFeed(`${name} joined as ${basePlayer.role}.`);

    // show game + listen
    showScreen("gameScreen");
    listenRoom();
    updateRoleButtons();
  }

  $("joinBtn").onclick = joinOrCreate;

  $("howBtn").onclick = ()=>{
    openModal(`
      <h2>How to play</h2>
      <div class="hint">
        <b>Goal:</b> Survivors must survive <b>${MAX_NIGHTS} nights</b>.<br>
        <b>Lose:</b> <b>${MAX_FAILS} fails</b> or all Survivors lose hearts.<br><br>
        <b>Challenger</b> starts nights, picks challenges, manages Supply/Power and answers <b>Please</b> requests.<br>
        <b>Survivors</b> use Inventory, Trade and Please to help pass challenges.
      </div>
      <button class="btn btnGold" onclick="(${closeModal.toString()})()">Close</button>
    `);
  };

  /* =========================
     6) LISTEN + RENDER
     ========================= */
  function listenRoom(){
    if(roomUnsub) roomUnsub.off();
    const ref = db.ref(`rooms/${currentRoom}`);
    roomUnsub = ref;

    ref.on("value", snap=>{
      const data = snap.val();
      if(!data) return;
      lastRoomData = data;
      render(data);
    });
  }

  function render(data){
    // hud
    $("hudPhase").textContent = data.phase || "â€”";
    $("hudNight").textContent = `${data.night||0}/${MAX_NIGHTS}`;
    $("hudFails").textContent = `${data.fails||0}/${MAX_FAILS}`;
    $("hudEvent").textContent = data.event?.title || "â€”";

    $("hudSupply").textContent = (data.supply ?? "â€”");
    $("hudPower").textContent = (data.power ?? "â€”");

    const players = data.players || {};
    const pcount = Object.keys(players).length;
    $("hudPlayers").textContent = `${pcount}/${MAX_PLAYERS}`;

    const me = players[myId];
    if(me){
      $("hudRole").textContent = me.role || "â€”";
      $("hudHearts").textContent = "â¤ï¸".repeat(me.hearts||0) || "â€”";
      $("hudHunger").textContent = (me.role==="Survivor") ? `${me.hunger ?? 70}/70` : "â€”";
    }

    // timer
    if(data.timerEndsAt){
      const ms = data.timerEndsAt - now();
      $("hudTimer").textContent = ms>0 ? Math.ceil(ms/1000) + "s" : "0s";
    } else {
      $("hudTimer").textContent = "â€”";
    }

    // night card
    if(data.phase==="lobby"){
      $("nightMain").textContent = "Lobby";
      $("nightSub").textContent = "Everyone press Ready.";
      $("nightCard").classList.remove("pulse");
    }

    if(data.phase==="night"){
      const c = data.currentChallenge;
      $("nightMain").textContent = c?.title || "Challengeâ€¦";
      let extra = c ? `Difficulty: ${c.diff}` : "";
      if(data.event?.diffDelta) extra += ` (+${data.event.diffDelta} event)`;
      $("nightSub").textContent = extra || "Survivors choose actions.";
      $("nightCard").classList.add("pulse");
    }

    if(data.phase==="resolve"){
      $("nightMain").textContent = "Resolvingâ€¦";
      $("nightSub").textContent = "Calculating outcome.";
      $("nightCard").classList.remove("pulse");
    }

    if(data.phase==="end"){
      $("nightMain").textContent = data.endText || "Game ended";
      $("nightSub").textContent = "Refresh to play again.";
      $("nightCard").classList.remove("pulse");
    }

    // feed
    renderFeed(data.feed);

    // sound sync: only challenger can toggle, but everyone follows room soundOn
    if(data.soundOn && !audio._playing){
      tryPlayAudio();
    }
    if(!data.soundOn && audio._playing){
      audio.pause();
      audio._playing = false;
    }
    $("soundBtn").textContent = data.soundOn ? "ðŸ”Š" : "ðŸ”‡";

    updateRoleButtons();
    maybeAutoResolve(data);
  }

  function renderFeed(feedObj){
    const box = $("feedBox");
    const entries = feedObj ? Object.values(feedObj) : [];
    entries.sort((a,b)=>(a.t||0)-(b.t||0));
    const last = entries.slice(-40);
    box.innerHTML = last.map(x=>`<div class="feedItem">${escapeHtml(x.text||"")}</div>`).join("");
    box.scrollTop = box.scrollHeight;
  }

  function escapeHtml(s){
    return (s||"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function updateRoleButtons(){
    const data = lastRoomData;
    if(!data) return;
    const me = data.players?.[myId];
    const role = me?.role;

    $("pickChallengeBtn").disabled = !(role==="Challenger");
    $("startNightBtn").disabled = !(role==="Challenger");

    $("pleaseBtn").disabled = !(role==="Survivor") || data.phase!=="night";
    $("tradeBtn").disabled = !me;
    $("inventoryBtn").disabled = !me;

    // ready allowed in lobby
    $("readyBtn").disabled = (data.phase!=="lobby");

    // challenger should not have hunger / please
    if(role==="Challenger"){
      setHint("You are Challenger. Pick a challenge, manage Supply/Power, approve Please requests.");
    }else if(role==="Survivor"){
      setHint(data.phase==="night" ? "Use Please: Item / Heal / Skip Fail. Trade items with others." : "Get ready. Survive 7 nights.");
    }
  }

  /* =========================
     7) SOUND (only Challenger toggles)
     ========================= */
  async function tryPlayAudio(){
    try{
      await audio.play();
      audio._playing = true;
      localSoundEnabled = true;
    }catch(e){
      // mobile needs user gesture; show hint
      audio._playing = false;
      localSoundEnabled = false;
    }
  }

  $("soundBtn").onclick = async ()=>{
    const data = lastRoomData;
    if(!data) return;
    const me = data.players?.[myId];
    if(!me) return;

    if(me.role!=="Challenger"){
      toast("Only Challenger controls sound.");
      // But user gesture can still allow playback when room soundOn is true:
      if(data.soundOn && !audio._playing) tryPlayAudio();
      return;
    }

    const newVal = !data.soundOn;
    await db.ref(`rooms/${currentRoom}/soundOn`).set(newVal);
    pushFeed(newVal ? "Sound ON." : "Sound OFF.");
    if(newVal) tryPlayAudio();
  };

  /* =========================
     8) READY / LOBBY START CONDITIONS
     ========================= */
  $("readyBtn").onclick = async ()=>{
    const data = lastRoomData;
    if(!data) return;
    if(data.phase!=="lobby") return;

    const me = data.players?.[myId];
    if(!me) return;

    const newReady = !me.ready;
    await db.ref(`rooms/${currentRoom}/players/${myId}/ready`).set(newReady);
    pushFeed(`${me.name} is ${newReady ? "READY" : "NOT ready"}.`);
  };

  function allSurvivorsReady(data){
    const players = data.players||{};
    const vals = Object.values(players);
    const survivors = vals.filter(p=>p.role==="Survivor");
    if(survivors.length===0) return false;
    return survivors.every(p=>p.ready);
  }

  /* =========================
     9) INVENTORY MODAL
     ========================= */
  $("inventoryBtn").onclick = ()=>{
    const data = lastRoomData;
    const me = data?.players?.[myId];
    if(!me) return;

    const inv = me.inventory || {};
    const rows = ITEM_CATALOG.map(it=>{
      const q = inv[it.key]||0;
      return `<div class="listRow"><span>${it.icon} ${it.name}</span><span>x${q}</span></div>`;
    }).join("");

    openModal(`
      <h2>Inventory</h2>
      <div class="hint">Your items. Survivors start with Rope, Torch, Berries.</div>
      <div class="list">${rows}</div>
      <button class="btn btnGold" onclick="(${closeModal.toString()})()">Close</button>
    `);
  };

  /* =========================
     10) TRADE (dropdowns, no typing)
     ========================= */
  $("tradeBtn").onclick = ()=>{
    const data = lastRoomData;
    const players = data?.players||{};
    const me = players[myId];
    if(!me) return;

    const others = Object.values(players).filter(p=>p.id!==myId);
    const inv = me.inventory||{};

    const itemOptions = ITEM_CATALOG
      .filter(it => (inv[it.key]||0)>0)
      .map(it=>`<option value="${it.key}">${it.icon} ${it.name} (x${inv[it.key]})</option>`)
      .join("") || `<option value="">(No items)</option>`;

    const playerOptions = others.map(p=>`<option value="${p.id}">${escapeHtml(p.name)} (${p.role})</option>`).join("")
      || `<option value="">(No other players)</option>`;

    const incoming = data.tradeRequests || {};
    const incomingRows = Object.values(incoming)
      .filter(r=>r.to===myId)
      .slice(-12)
      .map(r=>{
        const it = itemByKey(r.item);
        return `
          <div class="listRow">
            <span>${escapeHtml(r.fromName)} â†’ you: ${it?.icon||""} ${it?.name||r.item} x${r.qty}</span>
            <span style="display:flex; gap:8px;">
              <button class="btn btnGreen" style="padding:8px 10px; font-size:13px;"
                onclick="acceptTrade('${r.id}')">Accept</button>
              <button class="btn btnRed" style="padding:8px 10px; font-size:13px;"
                onclick="declineTrade('${r.id}')">Decline</button>
            </span>
          </div>
        `;
      }).join("") || `<div class="hint">No incoming trades.</div>`;

    openModal(`
      <h2>Trade</h2>
      <div class="hint">Send an item to another player (dropdowns).</div>
      <div class="row">
        <div>
          <label>Item</label>
          <select id="tradeItem">${itemOptions}</select>
        </div>
        <div>
          <label>Qty</label>
          <select id="tradeQty">
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
        <div>
          <label>To player</label>
          <select id="tradeTo">${playerOptions}</select>
        </div>
      </div>
      <button class="btn btnGold" onclick="sendTrade()">Send Trade</button>

      <h2 style="margin-top:8px;">Incoming</h2>
      <div class="list">${incomingRows}</div>

      <button class="btn btnSoft" onclick="(${closeModal.toString()})()">Close</button>
    `);

    // attach to window for modal buttons
    window.sendTrade = async ()=>{
      const it = $("tradeItem")?.value;
      const qty = parseInt($("tradeQty")?.value||"1",10);
      const to = $("tradeTo")?.value;
      if(!it) return toast("No item to trade.");
      if(!to) return toast("No target player.");
      const have = inv[it]||0;
      if(have<qty) return toast("Not enough.");

      // create request
      const id = db.ref(`rooms/${currentRoom}/tradeRequests`).push().key;
      await db.ref(`rooms/${currentRoom}/tradeRequests/${id}`).set({
        id,
        from: myId,
        fromName: me.name,
        to,
        item: it,
        qty,
        t: now()
      });
      pushFeed(`${me.name} offered a trade.`);
      toast("Trade sent.");
    };

    window.acceptTrade = async (id)=>{
      const data2 = lastRoomData;
      const req = data2?.tradeRequests?.[id];
      if(!req || req.to!==myId) return;

      const me2 = data2.players?.[myId];
      const fromP = data2.players?.[req.from];
      if(!me2 || !fromP) return;

      const fromInvRef = db.ref(`rooms/${currentRoom}/players/${req.from}/inventory/${req.item}`);
      const toInvRef   = db.ref(`rooms/${currentRoom}/players/${myId}/inventory/${req.item}`);

      const fromQty = (fromP.inventory?.[req.item]||0);
      if(fromQty < req.qty){
        await db.ref(`rooms/${currentRoom}/tradeRequests/${id}`).remove();
        return toast("Sender no longer has item.");
      }

      // transfer
      await fromInvRef.set(fromQty - req.qty);
      const myQty = (me2.inventory?.[req.item]||0);
      await toInvRef.set(myQty + req.qty);

      await db.ref(`rooms/${currentRoom}/tradeRequests/${id}`).remove();
      pushFeed(`Trade accepted: ${fromP.name} â†’ ${me2.name}.`);
      toast("Trade accepted.");
    };

    window.declineTrade = async (id)=>{
      const data2 = lastRoomData;
      const req = data2?.tradeRequests?.[id];
      if(!req || req.to!==myId) return;
      await db.ref(`rooms/${currentRoom}/tradeRequests/${id}`).remove();
      pushFeed(`Trade declined.`);
      toast("Declined.");
    };
  };

  /* =========================
     11) CHALLENGE PICK + START NIGHT
     ========================= */
  $("pickChallengeBtn").onclick = ()=>{
    const data = lastRoomData;
    const me = data?.players?.[myId];
    if(!me || me.role!=="Challenger") return;

    const options = CHALLENGES.map((c,i)=>`
      <div class="listRow">
        <span><b>${escapeHtml(c.title)}</b> (diff ${c.diff})</span>
        <button class="btn btnGreen" style="padding:8px 10px; font-size:13px;" onclick="pickC(${i})">Pick</button>
      </div>
    `).join("");

    openModal(`
      <h2>Pick Challenge</h2>
      <div class="hint">Pick a challenge for tonight (or random). Event can modify difficulty.</div>
      <div class="list">${options}</div>
      <button class="btn btnGold" onclick="pickRandom()">Random</button>
      <button class="btn btnSoft" onclick="(${closeModal.toString()})()">Close</button>
    `);

    window.pickC = async (i)=>{
      const c = CHALLENGES[i];
      await db.ref(`rooms/${currentRoom}/currentChallenge`).set(c);
      pushFeed(`Challenger picked: ${c.title}.`);
      closeModal();
    };
    window.pickRandom = async ()=>{
      const c = CHALLENGES[Math.floor(Math.random()*CHALLENGES.length)];
      await db.ref(`rooms/${currentRoom}/currentChallenge`).set(c);
      pushFeed(`Challenger picked (random): ${c.title}.`);
      closeModal();
    };
  };

  $("startNightBtn").onclick = async ()=>{
    const data = lastRoomData;
    const me = data?.players?.[myId];
    if(!me || me.role!=="Challenger") return;

    if(data.phase !== "lobby" && data.phase !== "night") {
      // allow from resolve/end? no
    }

    // require at least 1 survivor
    const surv = Object.values(data.players||{}).filter(p=>p.role==="Survivor");
    if(surv.length===0) return alert("Need at least 1 Survivor.");

    // if lobby, require survivors ready
    if(data.phase==="lobby" && !allSurvivorsReady(data)){
      return alert("All Survivors must be READY.");
    }

    // choose challenge if none
    let challenge = data.currentChallenge;
    if(!challenge){
      challenge = CHALLENGES[Math.floor(Math.random()*CHALLENGES.length)];
      await db.ref(`rooms/${currentRoom}/currentChallenge`).set(challenge);
    }

    // random event each night
    const ev = EVENT_LIST[Math.floor(Math.random()*EVENT_LIST.length)];
    await db.ref(`rooms/${currentRoom}/event`).set(ev);

    // reset action buckets
    await db.ref(`rooms/${currentRoom}/actions`).set({});
    await db.ref(`rooms/${currentRoom}/pleaseRequests`).set({});

    // increment night
    const nextNight = (data.night||0) + 1;
    await db.ref(`rooms/${currentRoom}/night`).set(nextNight);

    // set phase to night + timer
    const endsAt = now() + 30000; // 30s
    await db.ref(`rooms/${currentRoom}`).update({
      phase: "night",
      timerEndsAt: endsAt
    });

    // reset ready flags for survivors for next lobby later
    for(const p of Object.values(data.players||{})){
      if(p.role==="Survivor"){
        db.ref(`rooms/${currentRoom}/players/${p.id}/ready`).set(false);
      }
    }

    pushFeed(`Night ${nextNight} started: ${challenge.title} (${ev.title}).`);
  };

  /* =========================
     12) PLEASE (3 options) + Challenger cost 1-2 supply
     ========================= */
  $("pleaseBtn").onclick = ()=>{
    const data = lastRoomData;
    if(!data || data.phase!=="night") return;

    const me = data.players?.[myId];
    if(!me || me.role!=="Survivor") return;

    const inv = me.inventory||{};
    const invOptions = ITEM_CATALOG
      .filter(it => (inv[it.key]||0)>0)
      .map(it=>`<option value="${it.key}">${it.icon} ${it.name} (x${inv[it.key]})</option>`)
      .join("") || `<option value="">(No items)</option>`;

    openModal(`
      <h2>Please</h2>
      <div class="hint">
        Choose one option for this night. Challenger will approve and choose cost (1â€“2 supply).
      </div>

      <div class="paper" style="padding:10px; border-radius:14px; border:1px solid rgba(0,0,0,.12); background: rgba(255,255,255,.75);">
        <label>Option</label>
        <select id="plType">
          <option value="item">Item (use 1 item)</option>
          <option value="heal">Heal (+1 heart)</option>
          <option value="skipfail">Skip Fail (protect team)</option>
        </select>

        <div id="plItemBox" style="margin-top:10px;">
          <label>Pick item</label>
          <select id="plItem">${invOptions}</select>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn btnGold" onclick="sendPlease()">Send</button>
          <button class="btn btnSoft" onclick="(${closeModal.toString()})()">Close</button>
        </div>
      </div>
    `);

    $("plType").onchange = ()=>{
      const t = $("plType").value;
      $("plItemBox").style.display = (t==="item") ? "block" : "none";
    };

    window.sendPlease = async ()=>{
      const t = $("plType").value;
      const item = $("plItem")?.value || null;

      if(t==="item" && !item) return toast("No item.");

      const id = db.ref(`rooms/${currentRoom}/pleaseRequests`).push().key;
      await db.ref(`rooms/${currentRoom}/pleaseRequests/${id}`).set({
        id,
        from: myId,
        fromName: me.name,
        type: t,
        item,
        status: "pending",
        cost: 1,
        t: now()
      });

      pushFeed(`${me.name} sent a Please request.`);
      toast("Please sent.");
      closeModal();
    };
  };

  /* Challenger sees & approves Please requests automatically via Role Action (reuse PickChallengeBtn slot) */
  $("pickChallengeBtn").addEventListener("contextmenu", (e)=>e.preventDefault()); // no menu

  // Add a "Role Action" style: long press not reliable, so we show approvals inside Pick Challenge modal for Challenger during night:
  $("pickChallengeBtn").onclick = ()=>{
    const data = lastRoomData;
    const me = data?.players?.[myId];
    if(!me || me.role!=="Challenger") return;

    const reqs = Object.values(data.pleaseRequests||{}).sort((a,b)=>(a.t||0)-(b.t||0));
    const pending = reqs.filter(r=>r.status==="pending");
    const reqRows = pending.map(r=>{
      const typeLabel = r.type==="item" ? `Item: ${(itemByKey(r.item)?.icon||"")} ${(itemByKey(r.item)?.name||r.item)}`
                       : r.type==="heal" ? "Heal (+1 heart)"
                       : "Skip Fail";
      return `
        <div class="listRow">
          <span><b>${escapeHtml(r.fromName)}</b> â€” ${escapeHtml(typeLabel)}</span>
          <span style="display:flex; gap:8px; align-items:center;">
            <select id="cost_${r.id}" style="padding:8px; border-radius:12px;">
              <option value="1">Cost 1</option>
              <option value="2">Cost 2</option>
            </select>
            <button class="btn btnGreen" style="padding:8px 10px; font-size:13px;" onclick="approvePlease('${r.id}')">Approve</button>
            <button class="btn btnRed" style="padding:8px 10px; font-size:13px;" onclick="denyPlease('${r.id}')">Deny</button>
          </span>
        </div>
      `;
    }).join("") || `<div class="hint">No pending Please requests.</div>`;

    // Also allow picking challenge in same modal
    const chRows = CHALLENGES.map((c,i)=>`
      <div class="listRow">
        <span><b>${escapeHtml(c.title)}</b> (diff ${c.diff})</span>
        <button class="btn btnGold" style="padding:8px 10px; font-size:13px;" onclick="pickC(${i})">Set</button>
      </div>
    `).join("");

    openModal(`
      <h2>Challenger Panel</h2>
      <div class="hint">Approve Please (choose cost 1â€“2 Supply). You can also set tonight's challenge.</div>

      <h2 style="margin-top:6px;">Please Requests</h2>
      <div class="list">${reqRows}</div>

      <h2 style="margin-top:6px;">Set Challenge</h2>
      <div class="list">${chRows}</div>

      <button class="btn btnSoft" onclick="(${closeModal.toString()})()">Close</button>
    `);

    window.pickC = async (i)=>{
      const c = CHALLENGES[i];
      await db.ref(`rooms/${currentRoom}/currentChallenge`).set(c);
      pushFeed(`Challenger set challenge: ${c.title}.`);
      toast("Challenge set.");
    };

    window.approvePlease = async (id)=>{
      const data2 = lastRoomData;
      const req = data2?.pleaseRequests?.[id];
      if(!req || req.status!=="pending") return;
      const cost = parseInt(document.getElementById(`cost_${id}`)?.value || "1",10);

      const supply = data2.supply ?? 0;
      if(supply < cost) return alert("Not enough Supply.");

      // deduct supply
      await db.ref(`rooms/${currentRoom}/supply`).set(supply - cost);

      // mark approved
      await db.ref(`rooms/${currentRoom}/pleaseRequests/${id}`).update({ status:"approved", cost });

      // apply effect
      await applyPleaseApproved(req);

      pushFeed(`Approved Please for ${req.fromName} (cost ${cost}).`);
      toast("Approved.");
    };

    window.denyPlease = async (id)=>{
      const data2 = lastRoomData;
      const req = data2?.pleaseRequests?.[id];
      if(!req || req.status!=="pending") return;
      await db.ref(`rooms/${currentRoom}/pleaseRequests/${id}`).update({ status:"denied" });
      pushFeed(`Denied Please for ${req.fromName}.`);
      toast("Denied.");
    };
  };

  async function applyPleaseApproved(req){
    const data = lastRoomData;
    if(!data) return;

    const p = data.players?.[req.from];
    if(!p) return;

    if(req.type==="item"){
      const it = req.item;
      const have = p.inventory?.[it]||0;
      if(have<=0) return;

      // consume item
      await db.ref(`rooms/${currentRoom}/players/${req.from}/inventory/${it}`).set(have-1);

      // add "support" action
      await db.ref(`rooms/${currentRoom}/actions/${req.from}`).set({
        type:"item",
        item: it,
        value: itemSupportValue(it, data.event),
        t: now()
      });
    }

    if(req.type==="heal"){
      const hearts = p.hearts||0;
      await db.ref(`rooms/${currentRoom}/players/${req.from}/hearts`).set(clamp(hearts+1,0,5));
      await db.ref(`rooms/${currentRoom}/actions/${req.from}`).set({ type:"heal", value:1, t: now() });
    }

    if(req.type==="skipfail"){
      await db.ref(`rooms/${currentRoom}/actions/${req.from}`).set({ type:"skipfail", value:1, t: now() });
    }
  }

  function itemSupportValue(itemKey, event){
    let v = 1;
    if(itemKey==="torch") v = 2;
    if(itemKey==="trap") v = 2;
    if(itemKey==="berries") v = 1;
    if(itemKey==="rope") v = 2;
    if(itemKey==="medkit") v = 2;
    if(event?.tag==="rain" && itemKey==="torch") v = 1; // nerf torch in rain
    return v;
  }

  /* =========================
     13) AUTO-RESOLVE when timer ends OR all survivors have an action
     ========================= */
  async function maybeAutoResolve(data){
    if(!data || data.phase!=="night") return;
    if(!data.timerEndsAt) return;

    const ms = data.timerEndsAt - now();
    if(ms > 0) return;

    // avoid multiple resolves
    const resolveLockRef = db.ref(`rooms/${currentRoom}/resolveLock`);
    const lockSnap = await resolveLockRef.get();
    const lock = lockSnap.val();
    if(lock && now()-lock < 8000) return; // already resolving

    await resolveLockRef.set(now());
    await resolveNight();
  }

  async function resolveNight(){
    const roomRef = db.ref(`rooms/${currentRoom}`);
    const data = (await roomRef.get()).val();
    if(!data || data.phase!=="night") return;

    await roomRef.update({ phase:"resolve", timerEndsAt:null });

    const players = data.players||{};
    const survivors = Object.values(players).filter(p=>p.role==="Survivor");
    const challenge = data.currentChallenge || CHALLENGES[0];
    const event = data.event || null;

    let diff = challenge.diff || 3;
    if(event?.diffDelta) diff += event.diffDelta;

    // compute team support
    const actions = data.actions||{};
    let support = 0;
    let hasSkipFail = false;

    for(const s of survivors){
      const a = actions[s.id];
      if(!a) continue;
      if(a.type==="item") support += (a.value||0);
      if(a.type==="heal") support += 0; // heal doesn't help pass challenge
      if(a.type==="skipfail") hasSkipFail = true;
    }

    const success = support >= diff;

    // hunger tick for survivors each night
    for(const s of survivors){
      const h = s.hunger ?? 70;
      const delta = (event?.hungerDelta || 0);
      const newH = clamp(h - 10 + delta, 0, 70);
      await db.ref(`rooms/${currentRoom}/players/${s.id}/hunger`).set(newH);
      if(newH===0){
        const hearts = s.hearts||0;
        if(hearts>0) await db.ref(`rooms/${currentRoom}/players/${s.id}/hearts`).set(hearts-1);
      }
    }

    if(success){
      pushFeed(`âœ… Success! Support ${support}/${diff}.`);
    }else{
      if(hasSkipFail){
        pushFeed(`ðŸ›¡ï¸ Fail avoided by Skip Fail! Support ${support}/${diff}.`);
      }else{
        const newFails = (data.fails||0) + 1;
        await db.ref(`rooms/${currentRoom}/fails`).set(newFails);
        pushFeed(`âŒ Failed! Support ${support}/${diff}. Fails now ${newFails}/${MAX_FAILS}.`);

        // lose 1 heart from a random survivor
        if(survivors.length){
          const victim = survivors[Math.floor(Math.random()*survivors.length)];
          const hearts = victim.hearts||0;
          if(hearts>0){
            await db.ref(`rooms/${currentRoom}/players/${victim.id}/hearts`).set(hearts-1);
            pushFeed(`ðŸ’” ${victim.name} lost 1 heart.`);
          }
        }
      }
    }

    // check win/lose
    const dataAfter = (await roomRef.get()).val();
    const playersAfter = dataAfter.players||{};
    const survAfter = Object.values(playersAfter).filter(p=>p.role==="Survivor");
    const anyAlive = survAfter.some(p=>(p.hearts||0)>0);

    if((dataAfter.fails||0) >= MAX_FAILS || !anyAlive){
      await roomRef.update({
        phase:"end",
        endText: "DEFEAT",
      });
      pushFeed("Game Over: Defeat.");
      return;
    }

    if((dataAfter.night||0) >= MAX_NIGHTS){
      await roomRef.update({
        phase:"end",
        endText: "VICTORY",
      });
      pushFeed("Game Over: Victory!");
      return;
    }

    // back to lobby
    await roomRef.update({
      phase:"lobby",
      currentChallenge: null,
      event: null,
      actions: {},
      pleaseRequests: {},
      tradeRequests: {}
    });
    pushFeed("Back to lobby. Press Ready for next night.");
  }

  /* =========================
     14) SAFETY: if assets missing show a hint
     ========================= */
  window.addEventListener("error", (e)=>{
    // quiet
  });

</script>

</body>
</html>
