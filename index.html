<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Survival Challenge</title>

<!-- FIREBASE (NE DIRAJ) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<style>
:root{
  --ink:#2b1b10;
  --paper:#f7eed6;
  --paper2:#f3e5c6;
  --shadow: rgba(0,0,0,.25);
  --shadow2: rgba(0,0,0,.18);
  --btnText:#2b1b10;
  --btnHi:#ffe69c;
  --btnLo:#e2b85a;
  --glass: rgba(0,0,0,.20);
  --glassBorder: rgba(255,255,255,.18);
  --dangerHi:#ff7b7b;
  --dangerLo:#d64545;
  --okHi:#5fe36b;
  --okLo:#1ea13a;

  --safeTop: env(safe-area-inset-top, 0px);
  --safeBottom: env(safe-area-inset-bottom, 0px);
  --safeLeft: env(safe-area-inset-left, 0px);
  --safeRight: env(safe-area-inset-right, 0px);
}

*{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
html, body{ height:100%; }
body{
  margin:0; padding:0; overflow:hidden;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--ink);
  touch-action: manipulation;

  /* WOOD BACKGROUND (CSS-only) */
  background:
    radial-gradient(1200px 600px at 30% 20%, rgba(255,255,255,.18), transparent 60%),
    radial-gradient(900px 500px at 80% 40%, rgba(0,0,0,.18), transparent 55%),
    repeating-linear-gradient(90deg,
      rgba(90,55,30,.55) 0px, rgba(90,55,30,.55) 18px,
      rgba(120,75,40,.55) 18px, rgba(120,75,40,.55) 36px,
      rgba(75,45,25,.55) 36px, rgba(75,45,25,.55) 54px
    ),
    linear-gradient(#6a3f22, #3d2413);
}

/* ---------- Common UI ---------- */
.card{
  background: linear-gradient(var(--paper), var(--paper2));
  border: 1px solid rgba(0,0,0,.25);
  border-radius: 18px;
  box-shadow: 0 18px 28px var(--shadow), inset 0 2px 0 rgba(255,255,255,.75);
}

.glass{
  background: var(--glass);
  border: 1px solid var(--glassBorder);
  border-radius: 18px;
  backdrop-filter: blur(6px);
}

.pill{
  font-size:14px;
  padding:8px 10px;
  border-radius:14px;
  background: linear-gradient(var(--paper), var(--paper2));
  border:1px solid rgba(0,0,0,.25);
  box-shadow: 0 10px 16px var(--shadow2), inset 0 2px 0 rgba(255,255,255,.7);
  user-select:none;
  white-space:nowrap;
}

button{
  border:0;
  border-radius:16px;
  padding:12px 16px;
  font-size:18px;
  font-weight:800;
  color: var(--btnText);
  background: linear-gradient(var(--btnHi), var(--btnLo));
  box-shadow:
    0 10px 18px var(--shadow),
    inset 0 2px 0 rgba(255,255,255,.75),
    inset 0 -3px 0 rgba(0,0,0,.18);
  cursor:pointer;
  transition: transform .08s ease, filter .08s ease;
}
button:hover{ filter:brightness(1.03); transform: translateY(-1px); }
button:active{ transform: translateY(1px) scale(.99); }
button:disabled{ opacity:.6; cursor:not-allowed; filter:saturate(.7); }

.btnOk{ background: linear-gradient(var(--okHi), var(--okLo)); color:#0b2a10; }
.btnDanger{ background: linear-gradient(var(--dangerHi), var(--dangerLo)); color:#2b0b0b; }

.input, .select{
  font-size:18px;
  padding:12px 12px;
  border:2px solid rgba(0,0,0,.35);
  border-radius:16px;
  background: rgba(255,255,255,.92);
  box-shadow: 0 10px 18px var(--shadow2), inset 0 2px 0 rgba(255,255,255,.75);
  outline:none;
  width:100%;
}

.small{
  font-size:14px;
  opacity:.9;
}

/* ---------- Start Screen ---------- */
#startScreen{
  position:fixed; inset:0;
  padding: calc(16px + var(--safeTop)) calc(16px + var(--safeRight)) calc(18px + var(--safeBottom)) calc(16px + var(--safeLeft));
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  gap:12px;
}

.title{
  margin:0;
  font-size:44px;
  font-weight:1000;
  letter-spacing:.2px;
  text-align:center;
  color:#ffeaa3;
  text-shadow: 0 3px 0 rgba(0,0,0,.55), 0 10px 24px rgba(0,0,0,.35);
}
.byline{
  margin:0;
  text-align:center;
  color: rgba(255,255,255,.86);
  font-size:14px;
  text-shadow: 0 2px 0 rgba(0,0,0,.35);
}
.subtitle{
  margin:0 0 6px 0;
  text-align:center;
  font-size:16px;
  color: rgba(255,255,255,.92);
  text-shadow: 0 2px 0 rgba(0,0,0,.35);
}

.startCard{
  width:min(520px, 100%);
  padding:14px;
}
.startRow{
  display:flex;
  gap:10px;
  width:100%;
}
.startRow > *{ flex:1; }

#joinGameBtn{ width:100%; padding:14px 16px; font-size:20px; }

/* ---------- Game Screen ---------- */
#gameScreen{
  position:fixed; inset:0;
  display:none;
  padding: calc(10px + var(--safeTop)) calc(10px + var(--safeRight)) calc(10px + var(--safeBottom)) calc(10px + var(--safeLeft));
}

#topBar{
  position:sticky;
  top: calc(8px + var(--safeTop));
  z-index:30;
  padding:8px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

#topLine{
  display:flex; gap:8px; align-items:center; justify-content:space-between;
}
#pillsLine{
  display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
}

#playersWrap{
  display:flex; gap:8px; overflow:auto;
  padding-bottom:6px;
  -webkit-overflow-scrolling: touch;
}
.playerChip{
  flex:0 0 auto;
  cursor:pointer;
}

#mainArea{
  position:relative;
  margin-top:10px;
  height: calc(100% - 210px);
  min-height: 280px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

#feed{
  padding:10px;
}
#feedTitle{ margin:0 0 8px 0; font-size:14px; font-weight:900; }
#feedList{
  max-height:120px;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}
.feedItem{
  margin:6px 0;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.22);
  background: rgba(255,255,255,.85);
  box-shadow: inset 0 2px 0 rgba(255,255,255,.75);
  font-size:14px;
}

#cards{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
  flex:1;
  min-height: 140px;
}
@media (min-width: 820px){
  #cards{ grid-template-columns: 1fr 1fr; }
  #mainArea{ height: calc(100% - 170px); }
  #feedList{ max-height:150px; }
}

.cardBox{
  padding:12px;
}
.cardBox h2{
  margin:0 0 10px 0;
  font-size:16px;
  letter-spacing:.3px;
}
.cardFace{
  height: 100%;
  min-height: 120px;
  border-radius:16px;
  border:1px solid rgba(0,0,0,.22);
  background:
    radial-gradient(800px 300px at 20% 10%, rgba(255,255,255,.35), transparent 60%),
    linear-gradient(#fff8e9, #f1e0bd);
  box-shadow: inset 0 2px 0 rgba(255,255,255,.8);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:20px;
  font-weight:1000;
  padding:12px;
}

#bottomBar{
  position:fixed;
  left:0; right:0;
  bottom:0;
  padding: 10px calc(10px + var(--safeRight)) calc(10px + var(--safeBottom)) calc(10px + var(--safeLeft));
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  background: linear-gradient(transparent, rgba(0,0,0,.25));
  z-index:40;
}

#bottomBar .card{
  width:min(920px, 100%);
  padding:10px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (min-width: 820px){
  #bottomBar .card{
    grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
  }
}

#hungerPill{
  display:flex; align-items:center; justify-content:center;
  gap:8px;
  font-weight:900;
}

#startNightBtn{
  grid-column: 1 / -1;
  padding:14px 16px;
  font-size:20px;
}

/* ---------- Viewing Overlay ---------- */
#viewingOverlay{
  position:fixed; inset:0;
  display:none;
  align-items:flex-start;
  justify-content:flex-start;
  padding: calc(14px + var(--safeTop)) calc(14px + var(--safeRight)) calc(14px + var(--safeBottom)) calc(14px + var(--safeLeft));
  background: rgba(0,0,0,.35);
  backdrop-filter: blur(6px);
  z-index:120;
}
#viewingText{
  color:#ffeaa3;
  font-size:24px;
  font-weight:1000;
  text-shadow: 0 3px 0 rgba(0,0,0,.55);
  margin:0;
}
#closeViewBtn{ margin-top:10px; }

/* ---------- Modals (full-screen friendly) ---------- */
.modalBack{
  position:fixed; inset:0;
  display:none;
  background: rgba(0,0,0,.55);
  z-index:200;
  padding: calc(12px + var(--safeTop)) calc(12px + var(--safeRight)) calc(12px + var(--safeBottom)) calc(12px + var(--safeLeft));
}
.modal{
  width:min(760px, 100%);
  margin:0 auto;
  max-height: calc(100% - 10px);
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  padding:14px;
}
.modal h2{ margin:0 0 10px 0; font-size:20px; }
.row{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  margin:10px 0;
}
.row .grow{ flex:1; min-width: 180px; }

.listBox{
  border-radius:16px;
  padding:10px;
  background: rgba(255,255,255,.80);
  border:1px dashed rgba(0,0,0,.35);
  max-height: 46vh;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}

.itemPill{
  display:flex; justify-content:space-between; align-items:center; gap:10px;
  border-radius:14px;
  padding:10px 10px;
  margin:8px 0;
  border:1px solid rgba(0,0,0,.22);
  background: rgba(255,255,255,.90);
}
.badge{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:28px; height:24px; padding:0 8px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.22);
  background: rgba(255,255,255,.75);
  font-weight:1000;
}
.icon{ font-size:18px; margin-right:6px; }

.smallBtn{
  font-size:16px;
  padding:10px 12px;
  border-radius:14px;
}

hr{ border:none; border-top:1px dashed rgba(0,0,0,.35); margin:12px 0; }
</style>
</head>

<body>

<!-- START -->
<div id="startScreen">
  <h1 class="title">Survival Challenge</h1>
  <p class="byline">(by David Toma)</p>
  <p class="subtitle">Mobile-first online multiplayer ‚Äî max 4 players</p>

  <div class="card startCard">
    <div class="startRow">
      <div>
        <div class="small" style="font-weight:900; margin:0 0 6px 2px;">Your name</div>
        <input id="nameInput" class="input" type="text" maxlength="14" placeholder="David" />
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="startRow">
      <div>
        <div class="small" style="font-weight:900; margin:0 0 6px 2px;">Room code</div>
        <input id="gameCodeInput" class="input" type="text" maxlength="6" placeholder="ABCD12" />
      </div>
    </div>

    <div style="height:12px"></div>

    <button id="joinGameBtn">Join / Create</button>

    <div class="small" style="margin-top:10px;">
      Tip: open the same link on two phones and enter the same room code.
    </div>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen">

  <div id="topBar" class="glass">
    <div id="topLine">
      <div class="pill" id="rolePill">Role: ...</div>
      <div class="pill" id="readyPill">Ready: ...</div>
    </div>
    <div id="playersWrap"></div>
  </div>

  <div id="mainArea">
    <div id="feed" class="card">
      <p id="feedTitle"><b>Room Feed</b></p>
      <div id="feedList"></div>
    </div>

    <div id="cards">
      <div class="card cardBox">
        <h2>Night Card (3 sec)</h2>
        <div id="nightCard" class="cardFace"></div>
      </div>
      <div class="card cardBox">
        <h2>Status</h2>
        <div id="statusCard" class="cardFace">Join a room to start.</div>
      </div>
    </div>
  </div>

  <div id="bottomBar">
    <div class="card">
      <div id="hungerPill" class="pill">
        üçó Hunger: <span id="hungerValue">70</span>/70
      </div>
      <button id="inventoryBtn">Inventory</button>
      <button id="tradeBtn">Trade</button>
      <button id="pleaseBtn">Please</button>
      <button id="readyBtn" class="btnOk">Ready</button>
      <button id="startNightBtn" class="btnDanger" disabled>Start Night</button>
    </div>
  </div>
</div>

<!-- VIEWING -->
<div id="viewingOverlay">
  <div>
    <p id="viewingText">VIEWING...</p>
    <button id="closeViewBtn">Close</button>
  </div>
</div>

<!-- INVENTORY MODAL -->
<div id="invBack" class="modalBack">
  <div class="modal card">
    <h2>Inventory</h2>
    <div class="small">Starter kit is added automatically when you first join a room.</div>

    <div class="row">
      <div class="grow">
        <input id="invItemInput" class="input" placeholder="e.g. Rope" />
      </div>
      <div style="width:110px;">
        <input id="invQtyInput" class="input" type="number" min="1" value="1" />
      </div>
      <button id="invAddBtn" class="smallBtn">Add</button>
      <button id="invCloseBtn" class="smallBtn">Close</button>
    </div>

    <div id="invList" class="listBox"></div>
  </div>
</div>

<!-- TRADE MODAL -->
<div id="tradeBack" class="modalBack">
  <div class="modal card">
    <h2>Trade</h2>
    <div class="small">Send 1 item to another player. They can accept/decline.</div>

    <div class="row">
      <div class="grow">
        <select id="tradeTarget" class="select"></select>
      </div>
      <div class="grow">
        <input id="tradeItem" class="input" placeholder="Item name (exact, e.g. Rope)" />
      </div>
      <button id="tradeSendBtn" class="smallBtn">Send x1</button>
      <button id="tradeCloseBtn" class="smallBtn">Close</button>
    </div>

    <hr />
    <div class="small" style="font-weight:900; margin-bottom:8px;">Inbox</div>
    <div id="tradeInbox" class="listBox"></div>
  </div>
</div>

<!-- PLEASE MODAL (Challenger only) -->
<div id="pleaseBack" class="modalBack">
  <div class="modal card">
    <h2>Requests</h2>
    <div class="small">Only Challenger sees this inbox.</div>

    <div id="pleaseInbox" class="listBox" style="margin-top:10px;"></div>

    <div class="row" style="justify-content:flex-end;">
      <button id="pleaseCloseBtn" class="smallBtn">Close</button>
    </div>
  </div>
</div>

<script>
/* ============================
   FIREBASE CONFIG (TVOJ PROJEKT)
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyD6T_zbq3-fhN10aCF9zZtWJxV0eMg8fZQ",
  authDomain: "survivalchallengedt.firebaseapp.com",
  databaseURL: "https://survivalchallengedt-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "survivalchallengedt",
  storageBucket: "survivalchallengedt.firebasestorage.app",
  messagingSenderId: "953781088335",
  appId: "1:953781088335:web:fc26e2fb17717004eeba3a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============================
   SETTINGS
   ============================ */
const MAX_PLAYERS = 4;

// Mobile-friendly starter kit (trade + survival)
const STARTER_ITEMS = [
  { id:"water",   name:"Water",   icon:"üíß", qty:2 },
  { id:"berries", name:"Berries", icon:"ü´ê", qty:2 },
  { id:"rope",    name:"Rope",    icon:"ü™¢", qty:1 },
  { id:"torch",   name:"Torch",   icon:"üî•", qty:1 },
  { id:"trap",    name:"Trap",    icon:"ü™§", qty:1 }
];

/* ============================
   STATE
   ============================ */
let myId = localStorage.getItem("sc_myId");
if (!myId) {
  myId = Math.random().toString(36).slice(2, 10);
  localStorage.setItem("sc_myId", myId);
}
let currentRoom = null;
let roomCache = null;
let myRole = "Survivor";
let lastAnimal = null;

/* ============================
   UTIL
   ============================ */
function esc(s){
  return String(s ?? "").replace(/[<>&"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c]));
}
function nowId(){
  return Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 8);
}
function setStatus(text){
  document.getElementById("statusCard").textContent = text;
}
function showGame(){
  document.getElementById("startScreen").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";
}
function addFeed(text){
  const feed = document.getElementById("feedList");
  const div = document.createElement("div");
  div.className = "feedItem";
  div.innerHTML = esc(text);
  feed.prepend(div);
  while(feed.children.length > 30) feed.removeChild(feed.lastChild);
}

/* ============================
   INVENTORY HELPERS
   ============================ */
function normalizeInventory(inv){
  const arr = Array.isArray(inv) ? inv : [];
  return arr
    .filter(it => it && typeof it.name === "string")
    .map(it => ({
      id: String(it.id || it.name).toLowerCase().replace(/\s+/g,"-").slice(0,30),
      name: String(it.name).trim().slice(0,30),
      icon: String(it.icon || "üéí").slice(0,3),
      qty: Math.max(1, parseInt(it.qty || 1, 10))
    }));
}
function findItemIndex(inv, name){
  const n = String(name||"").trim().toLowerCase();
  return inv.findIndex(it => it.name.toLowerCase() === n);
}
function iconForName(name){
  const n = String(name||"").trim().toLowerCase();
  if (n.includes("water")) return "üíß";
  if (n.includes("berry")) return "ü´ê";
  if (n.includes("rope")) return "ü™¢";
  if (n.includes("torch")) return "üî•";
  if (n.includes("trap")) return "ü™§";
  if (n.includes("meat")) return "ü•©";
  if (n.includes("wood")) return "ü™µ";
  if (n.includes("stone")) return "ü™®";
  return "üéí";
}

/* ============================
   UI RENDER
   ============================ */
function renderPlayers(playersObj){
  const wrap = document.getElementById("playersWrap");
  wrap.innerHTML = "";
  if (!playersObj) return;

  const arr = Object.values(playersObj).sort((a,b) => (a.joinedAt||0) - (b.joinedAt||0));
  arr.forEach(p => {
    const chip = document.createElement("div");
    chip.className = "pill playerChip";
    const readyDot = p.ready ? "‚úÖ" : "‚è≥";
    chip.textContent = `${readyDot} ${p.name}: ${"‚ù§Ô∏è".repeat(p.hearts || 0)}`;
    chip.onclick = () => openViewing(p.id);
    wrap.appendChild(chip);
  });
}

function updatePills(room){
  const players = room?.players || {};
  const me = players[myId];
  myRole = me?.role || myRole;

  document.getElementById("rolePill").textContent = `Role: ${myRole}`;

  const total = Object.keys(players).length;
  const ready = Object.values(players).filter(p => p.ready).length;
  document.getElementById("readyPill").textContent = `Ready: ${ready}/${total}`;

  const allReady = total > 0 && ready === total;
  document.getElementById("startNightBtn").disabled = !(myRole === "Challenger" && allReady);

  const readyBtn = document.getElementById("readyBtn");
  const isReady = !!players?.[myId]?.ready;
  readyBtn.textContent = isReady ? "Unready" : "Ready";
  readyBtn.classList.toggle("btnOk", !isReady);
  readyBtn.classList.toggle("btnDanger", isReady);
}

function showAnimalFor3Sec(animal){
  if (!animal || animal === lastAnimal) return;
  lastAnimal = animal;
  const el = document.getElementById("nightCard");
  el.textContent = animal;
  setTimeout(()=> el.textContent="", 3000);
}

/* ============================
   INVENTORY MODAL
   ============================ */
function openInventory(){
  document.getElementById("invBack").style.display = "block";
  renderInventory(roomCache?.players?.[myId]?.inventory || []);
}
function closeInventory(){
  document.getElementById("invBack").style.display = "none";
}
function renderInventory(items){
  const box = document.getElementById("invList");
  box.innerHTML = "";
  const arr = normalizeInventory(items);

  if (arr.length === 0){
    const p = document.createElement("div");
    p.style.opacity = ".85";
    p.textContent = "Empty inventory.";
    box.appendChild(p);
    return;
  }

  arr.forEach((it, idx) => {
    const row = document.createElement("div");
    row.className = "itemPill";

    const left = document.createElement("div");
    left.innerHTML = `<span class="icon">${esc(it.icon)}</span><b>${esc(it.name)}</b> <span class="badge">x${it.qty}</span>`;
    row.appendChild(left);

    const minus = document.createElement("button");
    minus.className = "smallBtn btnDanger";
    minus.textContent = "-1";
    minus.onclick = async () => {
      const newInv = arr.slice();
      newInv[idx].qty -= 1;
      if (newInv[idx].qty <= 0) newInv.splice(idx, 1);
      await db.ref(`rooms/${currentRoom}/players/${myId}/inventory`).set(newInv);
      addFeed(`Used 1 ${it.name}`);
    };

    const plus = document.createElement("button");
    plus.className = "smallBtn btnOk";
    plus.textContent = "+1";
    plus.onclick = async () => {
      const newInv = arr.slice();
      newInv[idx].qty += 1;
      await db.ref(`rooms/${currentRoom}/players/${myId}/inventory`).set(newInv);
      addFeed(`Gained 1 ${it.name}`);
    };

    row.appendChild(minus);
    row.appendChild(plus);
    box.appendChild(row);
  });
}

async function addInventoryItem(name, qty){
  const itemName = String(name||"").trim().slice(0,30);
  const q = Math.max(1, parseInt(qty||1,10));
  if (!itemName) return;

  const invRef = db.ref(`rooms/${currentRoom}/players/${myId}/inventory`);
  const snap = await invRef.get();
  const inv = normalizeInventory(snap.exists() ? snap.val() : []);
  const i = findItemIndex(inv, itemName);

  if (i >= 0) inv[i].qty += q;
  else inv.push({ id:itemName.toLowerCase().replace(/\s+/g,"-"), name:itemName, icon:iconForName(itemName), qty:q });

  await invRef.set(inv);
  addFeed(`Added ${q} ${itemName}`);
}

/* ============================
   TRADE MODAL
   ============================ */
function openTrade(){
  document.getElementById("tradeBack").style.display = "block";
  refreshTradeTargets();
  renderTradeInbox(roomCache?.tradeRequests?.[myId] || {});
}
function closeTrade(){
  document.getElementById("tradeBack").style.display = "none";
}
function refreshTradeTargets(){
  const sel = document.getElementById("tradeTarget");
  sel.innerHTML = "";

  const players = roomCache?.players || {};
  const others = Object.values(players).filter(p => p.id !== myId);

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = others.length ? "Choose player..." : "No other players";
  sel.appendChild(opt0);

  others.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.name} (${p.role || "Survivor"})`;
    sel.appendChild(opt);
  });
}
function renderTradeInbox(inboxObj){
  const box = document.getElementById("tradeInbox");
  box.innerHTML = "";

  const entries = inboxObj ? Object.entries(inboxObj) : [];
  if (entries.length === 0){
    const p = document.createElement("div");
    p.style.opacity = ".85";
    p.textContent = "No incoming trades.";
    box.appendChild(p);
    return;
  }

  entries.sort((a,b)=> (b[1]?.createdAt||0) - (a[1]?.createdAt||0));

  entries.forEach(([reqId, req]) => {
    const fromName = roomCache?.players?.[req.fromId]?.name || req.fromId;

    const row = document.createElement("div");
    row.className = "itemPill";
    row.innerHTML = `<div><b>${esc(fromName)}</b> offers: <b>${esc(req.item)}</b> <span class="badge">x1</span></div>`;

    const accept = document.createElement("button");
    accept.className = "smallBtn btnOk";
    accept.textContent = "Accept";
    accept.onclick = () => acceptTrade(reqId, req);

    const decline = document.createElement("button");
    decline.className = "smallBtn btnDanger";
    decline.textContent = "Decline";
    decline.onclick = () => declineTrade(reqId);

    row.appendChild(accept);
    row.appendChild(decline);
    box.appendChild(row);
  });
}

async function sendTrade(targetId, itemName){
  const item = String(itemName||"").trim().slice(0,30);
  if (!targetId) return alert("Choose a player.");
  if (!item) return alert("Type an item name.");

  const myInv = normalizeInventory(roomCache?.players?.[myId]?.inventory || []);
  const idx = findItemIndex(myInv, item);
  if (idx < 0 || myInv[idx].qty < 1) return alert("You don't have that item.");

  const reqId = nowId();
  await db.ref(`rooms/${currentRoom}/tradeRequests/${targetId}/${reqId}`).set({
    id:reqId, fromId:myId, toId:targetId, item, createdAt:Date.now()
  });

  addFeed(`Trade sent: ${item} ‚Üí ${roomCache?.players?.[targetId]?.name || targetId}`);
}

async function declineTrade(reqId){
  await db.ref(`rooms/${currentRoom}/tradeRequests/${myId}/${reqId}`).remove();
  addFeed("Trade declined.");
}

async function acceptTrade(reqId, req){
  const fromId = req.fromId;
  const item = req.item;

  const fromInvRef = db.ref(`rooms/${currentRoom}/players/${fromId}/inventory`);
  const myInvRef = db.ref(`rooms/${currentRoom}/players/${myId}/inventory`);

  const [fromSnap, mySnap] = await Promise.all([fromInvRef.get(), myInvRef.get()]);
  const fromInv = normalizeInventory(fromSnap.exists() ? fromSnap.val() : []);
  const myInv = normalizeInventory(mySnap.exists() ? mySnap.val() : []);

  const fi = findItemIndex(fromInv, item);
  if (fi < 0 || fromInv[fi].qty < 1){
    await declineTrade(reqId);
    return alert("Item no longer available.");
  }

  fromInv[fi].qty -= 1;
  if (fromInv[fi].qty <= 0) fromInv.splice(fi, 1);

  const mi = findItemIndex(myInv, item);
  if (mi >= 0) myInv[mi].qty += 1;
  else myInv.push({ id:item.toLowerCase().replace(/\s+/g,"-"), name:item, icon:iconForName(item), qty:1 });

  const updates = {};
  updates[`rooms/${currentRoom}/players/${fromId}/inventory`] = fromInv;
  updates[`rooms/${currentRoom}/players/${myId}/inventory`] = myInv;
  updates[`rooms/${currentRoom}/tradeRequests/${myId}/${reqId}`] = null;

  const evId = nowId();
  updates[`rooms/${currentRoom}/events/${evId}`] = {
    type:"trade",
    text:`Trade: ${roomCache?.players?.[fromId]?.name || fromId} ‚Üí ${roomCache?.players?.[myId]?.name || myId}: ${item} x1`,
    createdAt:Date.now()
  };

  await db.ref().update(updates);
  addFeed(`Trade accepted: +1 ${item}`);
}

/* ============================
   PLEASE
   ============================ */
function openPleaseModal(){
  document.getElementById("pleaseBack").style.display = "block";
  renderPleaseInbox(roomCache?.pleaseRequests?.[myId] || {});
}
function closePleaseModal(){
  document.getElementById("pleaseBack").style.display = "none";
}
function renderPleaseInbox(inboxObj){
  const box = document.getElementById("pleaseInbox");
  box.innerHTML = "";

  const entries = inboxObj ? Object.entries(inboxObj) : [];
  if (entries.length === 0){
    const p = document.createElement("div");
    p.style.opacity = ".85";
    p.textContent = "No requests.";
    box.appendChild(p);
    return;
  }

  entries.sort((a,b)=> (b[1]?.createdAt||0) - (a[1]?.createdAt||0));
  entries.forEach(([rid, r]) => {
    const fromName = roomCache?.players?.[r.fromId]?.name || r.fromId;

    const row = document.createElement("div");
    row.className = "itemPill";
    row.innerHTML = `<div><b>${esc(fromName)}</b> says: <b>${esc(r.message)}</b></div>`;

    const done = document.createElement("button");
    done.className = "smallBtn btnOk";
    done.textContent = "Done";
    done.onclick = async () => {
      await db.ref(`rooms/${currentRoom}/pleaseRequests/${myId}/${rid}`).remove();
      addFeed(`Handled PLEASE from ${fromName}`);
    };

    row.appendChild(done);
    box.appendChild(row);
  });
}

async function sendPlease(){
  if (!roomCache) return;
  const challengerId = roomCache.challengerId;
  if (!challengerId) return alert("No Challenger in room.");

  if (myRole === "Challenger"){
    openPleaseModal();
    return;
  }

  const rid = nowId();
  await db.ref(`rooms/${currentRoom}/pleaseRequests/${challengerId}/${rid}`).set({
    id:rid, fromId:myId, message:"PLEASE", createdAt:Date.now()
  });

  const evId = nowId();
  await db.ref(`rooms/${currentRoom}/events/${evId}`).set({
    type:"please",
    text:`${roomCache?.players?.[myId]?.name || myId} sent PLEASE`,
    createdAt:Date.now()
  });

  addFeed("PLEASE sent to Challenger.");
}

/* ============================
   READY + VIEWING
   ============================ */
async function toggleReady(){
  const me = roomCache?.players?.[myId];
  if (!me) return;
  await db.ref(`rooms/${currentRoom}/players/${myId}/ready`).set(!me.ready);
}

function openViewing(playerId){
  if (!playerId || playerId === myId) return;
  document.getElementById("viewingOverlay").style.display = "flex";
  document.getElementById("viewingText").textContent = "VIEWING " + playerId;
  db.ref(`rooms/${currentRoom}/players/${playerId}/beingViewedBy`).set(myId);
}
document.getElementById("closeViewBtn").onclick = () => {
  document.getElementById("viewingOverlay").style.display = "none";
};

/* ============================
   ROOM LISTENERS
   ============================ */
function listenRoom(){
  db.ref(`rooms/${currentRoom}`).on("value", snap => {
    const data = snap.val();
    if (!data) return;
    roomCache = data;

    renderPlayers(data.players);
    updatePills(data);

    if (data.players && data.players[myId]){
      document.getElementById("hungerValue").textContent = data.players[myId].hunger ?? 70;

      if (document.getElementById("invBack").style.display === "block"){
        renderInventory(data.players[myId].inventory || []);
      }
    }

    if (data.currentAnimal) showAnimalFor3Sec(data.currentAnimal);

    if (document.getElementById("tradeBack").style.display === "block"){
      refreshTradeTargets();
      renderTradeInbox(data.tradeRequests?.[myId] || {});
    }

    if (myRole === "Challenger"){
      const inbox = data.pleaseRequests?.[myId] || {};
      const count = Object.keys(inbox).length;
      if (count > 0 && document.getElementById("pleaseBack").style.display !== "block"){
        openPleaseModal();
        addFeed("New PLEASE request.");
      }
      if (document.getElementById("pleaseBack").style.display === "block"){
        renderPleaseInbox(inbox);
      }
    }
  });

  db.ref(`rooms/${currentRoom}/events`).limitToLast(25).on("child_added", snap => {
    const ev = snap.val();
    if (ev?.text) addFeed(ev.text);
  });
}

/* ============================
   JOIN / CREATE
   ============================ */
async function joinOrCreateRoom(code, playerName){
  currentRoom = code;
  const roomRef = db.ref(`rooms/${currentRoom}`);
  const snap = await roomRef.get();

  if (!snap.exists()){
    await roomRef.set({
      createdAt: Date.now(),
      night: 1,
      challengerId: myId,
      currentAnimal: null,
      players: {},
      events: {}
    });
  }

  const room = (await roomRef.get()).val();
  const players = room.players || {};

  // enforce max players (rejoin doesn't count twice)
  const count = Object.keys(players).filter(pid => pid !== myId).length + (players[myId] ? 0 : 1);
  if (count > MAX_PLAYERS){
    alert("Room is full (max 4).");
    return;
  }

  // challenger fallback if missing
  let challengerId = room.challengerId;
  if (!challengerId || !players[challengerId]){
    challengerId = myId;
    await db.ref(`rooms/${currentRoom}/challengerId`).set(challengerId);
  }
  const isChallenger = challengerId === myId;

  const name = (playerName || "").trim().slice(0,14) || ("Player-" + myId.slice(0,4));
  const existing = players[myId];
  const inv = existing?.inventory ? normalizeInventory(existing.inventory) : STARTER_ITEMS.slice();

  const playerRef = db.ref(`rooms/${currentRoom}/players/${myId}`);
  await playerRef.set({
    id: myId,
    name,
    hearts: 3,
    hunger: 70,
    role: isChallenger ? "Challenger" : "Survivor",
    ready: false,
    joinedAt: Date.now(),
    inventory: inv
  });

  // cleanup on disconnect
  playerRef.onDisconnect().remove();

  // event join
  const evId = nowId();
  await db.ref(`rooms/${currentRoom}/events/${evId}`).set({
    type:"join",
    text:`${name} joined.`,
    createdAt: Date.now()
  });

  showGame();
  setStatus("Open Inventory, Trade, Ready. Challenger starts when all ready.");
  listenRoom();
}

/* ============================
   START NIGHT
   ============================ */
document.getElementById("startNightBtn").onclick = async () => {
  if (!currentRoom || !roomCache) return;

  if (myRole !== "Challenger"){
    alert("Only Challenger can start night.");
    return;
  }

  const players = roomCache.players || {};
  const total = Object.keys(players).length;
  const ready = Object.values(players).filter(p => p.ready).length;

  if (!(total > 0 && ready === total)){
    alert("All players must be READY.");
    return;
  }

  const animals = ["Bear","Pig","Elephant","Snake","Tiger"];
  const chosen = animals[Math.floor(Math.random()*animals.length)];

  const updates = {};
  updates[`rooms/${currentRoom}/currentAnimal`] = chosen;
  updates[`rooms/${currentRoom}/night`] = (roomCache.night || 1) + 1;

  // reset ready for all
  Object.keys(players).forEach(pid => {
    updates[`rooms/${currentRoom}/players/${pid}/ready`] = false;
  });

  const evId = nowId();
  updates[`rooms/${currentRoom}/events/${evId}`] = {
    type:"night",
    text:`Night ${updates[`rooms/${currentRoom}/night`]} started: ${chosen}`,
    createdAt: Date.now()
  };

  await db.ref().update(updates);
  setStatus("Night started. Animal shows for 3 seconds.");
};

/* ============================
   BUTTONS
   ============================ */
document.getElementById("inventoryBtn").onclick = () => { if (currentRoom) openInventory(); };
document.getElementById("invCloseBtn").onclick = closeInventory;
document.getElementById("invAddBtn").onclick = () => {
  const name = document.getElementById("invItemInput").value;
  const qty  = document.getElementById("invQtyInput").value;
  document.getElementById("invItemInput").value = "";
  document.getElementById("invQtyInput").value = "1";
  addInventoryItem(name, qty);
};

document.getElementById("tradeBtn").onclick = () => { if (currentRoom) openTrade(); };
document.getElementById("tradeCloseBtn").onclick = closeTrade;
document.getElementById("tradeSendBtn").onclick = () => {
  const targetId = document.getElementById("tradeTarget").value;
  const item = document.getElementById("tradeItem").value;
  document.getElementById("tradeItem").value = "";
  sendTrade(targetId, item);
};

document.getElementById("pleaseBtn").onclick = () => { if (currentRoom) sendPlease(); };
document.getElementById("pleaseCloseBtn").onclick = closePleaseModal;

document.getElementById("readyBtn").onclick = () => { if (currentRoom) toggleReady(); };

document.getElementById("joinGameBtn").onclick = () => {
  const code = document.getElementById("gameCodeInput").value.trim().toUpperCase();
  const name = document.getElementById("nameInput").value;

  if (!code) return alert("Enter a code (e.g. ABCD12).");
  if (!/^[A-Z0-9]{2,6}$/.test(code)) return alert("Code: A-Z and 0-9 (2‚Äì6 chars).");

  joinOrCreateRoom(code, name);
};

/* Close modals by tapping outside (mobile-friendly) */
document.getElementById("invBack").addEventListener("click", (e)=>{ if(e.target.id==="invBack") closeInventory(); });
document.getElementById("tradeBack").addEventListener("click", (e)=>{ if(e.target.id==="tradeBack") closeTrade(); });
document.getElementById("pleaseBack").addEventListener("click", (e)=>{ if(e.target.id==="pleaseBack") closePleaseModal(); });
</script>

</body>
</html>
