<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Survival Challenge</title>

<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<style>
  :root{
    --safeTop: env(safe-area-inset-top, 0px);
    --safeBottom: env(safe-area-inset-bottom, 0px);
    --pad: 12px;
    --radius: 18px;
    --shadow: 0 10px 24px rgba(0,0,0,.25);
    --ink: #2b1d0e;
    --paper: rgba(255,255,255,.82);
  }
  *{ box-sizing:border-box; }
  html, body{ height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); }
  body{
    background: url("assets/wood.png") center/cover no-repeat fixed;
    overflow:hidden;
  }
  .paperOverlay{
    position:fixed; inset:0;
    background: url("assets/paper.png") center/cover no-repeat;
    opacity:.88;
    pointer-events:none;
  }
  .panel{
    background: var(--paper);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid rgba(0,0,0,.15);
    overflow:hidden;
  }
  .wrap{
    position:fixed; inset:0;
    padding: calc(var(--pad) + var(--safeTop)) var(--pad) calc(110px + var(--safeBottom)) var(--pad);
    display:flex; flex-direction:column;
    gap: 12px;
    overflow:hidden;
  }

  /* START */
  #startScreen{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    padding: 18px;
  }
  .startCard{ width:min(560px, 96vw); padding: 18px; text-align:center; }
  #logoImg{
    width:min(420px, 90%);
    height:auto;
    display:block;
    margin: 6px auto 10px auto;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
  }
  .startSmall{ margin: 0 0 14px 0; font-weight:800; opacity:.9; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
  input{
    font-size: 18px;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.25);
    outline:none;
    width: min(240px, 90vw);
    background: rgba(255,255,255,.90);
  }
  #roomCode{ text-transform:uppercase; letter-spacing:1px; font-weight:900; text-align:center; }

  button{
    font-size: 18px;
    font-weight: 950;
    border: 0;
    padding: 12px 16px;
    border-radius: 16px;
    cursor:pointer;
    box-shadow: 0 6px 16px rgba(0,0,0,.25);
    transition: transform .08s ease, filter .08s ease;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  button:active{ transform: scale(.98); filter: brightness(.98); }
  .btnGold{ background: linear-gradient(#ffe7a4, #e8b94a); color: var(--ink); }
  .btnGreen{ background: linear-gradient(#7ae37c, #2fa84b); color: #0c2a12; }
  .btnRed{ background: linear-gradient(#ff8b8b, #d83a3a); color: #2b0c0c; }
  .btnGray{ background: linear-gradient(#f0f0f0, #dcdcdc); color: #333; }
  .miniBtn{ font-size: 16px; padding: 8px 10px; border-radius: 12px; box-shadow:none; }

  /* GAME */
  #gameScreen{ display:none; position:fixed; inset:0; }
  .hudGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    padding: 12px;
    background: rgba(255,255,255,.55);
  }
  .hudCell{
    display:flex; align-items:center; justify-content:space-between;
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.78);
    border: 1px solid rgba(0,0,0,.12);
    font-weight: 950;
    min-height: 46px;
  }
  .hudCell small{ font-weight:950; opacity:.75; margin-right:10px; }
  .hudValue{ font-weight: 1000; }

  .mainRow{
    display:flex;
    gap: 12px;
    flex: 1;
    min-height: 0;
    overflow:hidden;
  }
  .feed{
    flex: 0 0 42%;
    min-width: 280px;
    display:flex;
    flex-direction:column;
  }
  .feedHeader{ padding: 12px 14px; font-weight: 1000; font-size: 22px; }
  .feedBox{
    margin: 0 12px 12px 12px;
    padding: 10px;
    border-radius: 16px;
    background: rgba(255,255,255,.78);
    border: 1px solid rgba(0,0,0,.12);
    height: 210px;
    overflow-y:auto;
    -webkit-overflow-scrolling: touch;
  }
  .feedLine{
    padding: 10px 10px;
    margin: 8px 0;
    border-radius: 14px;
    background: rgba(255,255,255,.72);
    border: 1px solid rgba(0,0,0,.08);
    font-weight: 950;
  }

  .cards{
    flex: 1;
    min-width: 0;
    display:flex;
    flex-direction:column;
    gap: 12px;
    overflow:hidden;
  }

  .nightPanel{
    padding: 12px;
    display:flex;
    flex-direction:column;
    gap: 10px;
    min-height: 220px;
  }
  .nightTitle{
    font-weight: 1000;
    font-size: 20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  #nightCard{
    flex: 1;
    min-height: 160px;
    border-radius: 18px;
    background:
      url("assets/card-frame.png") center/cover no-repeat,
      rgba(255,255,255,.78);
    border: 1px solid rgba(0,0,0,.15);
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding: 18px;
    font-weight: 1000;
    font-size: 24px;
    line-height: 1.15;
    position:relative;
    overflow:hidden;
  }
  .pop{ animation: pop .18s ease-out; }
  @keyframes pop{ from{ transform: scale(.985); filter: brightness(.96);} to{ transform: scale(1); filter: brightness(1);} }

  .itemsPanel{ padding: 12px; display:flex; flex-direction:column; gap: 10px; overflow:hidden; }
  .itemsTitle{ font-weight: 1000; font-size: 18px; display:flex; align-items:center; justify-content:space-between; }
  .itemsGrid{ display:flex; flex-wrap:wrap; gap: 10px; overflow:auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; }
  .itemChip{
    display:flex; align-items:center; gap: 8px;
    padding: 10px 12px; border-radius: 16px;
    background: rgba(255,255,255,.78);
    border: 1px solid rgba(0,0,0,.12);
    font-weight: 1000; white-space:nowrap;
  }

  /* Bottom controls always visible */
  .controls{
    position: fixed;
    left: var(--pad);
    right: var(--pad);
    bottom: calc(10px + var(--safeBottom));
    z-index: 50;
  }
  .controlsInner{
    padding: 12px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    background: rgba(255,255,255,.62);
  }
  .controlsInner button{
    width:100%;
    padding: 14px 12px;
    border-radius: 18px;
    font-size: 18px;
  }

  /* Modals */
  .modalBack{
    position:fixed; inset:0;
    background: rgba(0,0,0,.35);
    backdrop-filter: blur(4px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 100;
    padding: 16px;
  }
  .modal{
    width: min(620px, 98vw);
    max-height: min(84vh, 760px);
    overflow:auto;
    padding: 14px;
  }
  .modal h2{ margin: 6px 6px 10px 6px; font-size: 22px; }
  .field{ display:flex; gap: 10px; flex-wrap:wrap; padding: 6px; align-items:center; }
  select{
    font-size: 16px;
    padding: 12px 12px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.25);
    background: rgba(255,255,255,.90);
    min-width: 180px;
  }
  .hint{ margin: 8px 6px; opacity:.86; font-weight: 850; }

  /* Video overlay */
  #videoBack{ z-index: 300; }
  .videoWrap{ width:min(880px,98vw); }
  video{
    width:100%;
    border-radius: 18px;
    box-shadow: var(--shadow);
    background:#000;
  }

  /* Mobile: keep night & controls visible */
  @media (max-width: 880px){
    .wrap{ padding-bottom: calc(128px + var(--safeBottom)); }
    .mainRow{ flex-direction: column; overflow:hidden; }
    .feed{ min-width: 0; }
    .feedBox{ height: 150px; }
    .nightPanel{ min-height: 210px; }
    #nightCard{ min-height: 150px; font-size: 22px; }
  }
</style>
</head>

<body>
<div class="paperOverlay"></div>

<!-- START -->
<div id="startScreen">
  <div class="panel startCard">
    <img id="logoImg" src="assets/logo.png" alt="Survival Challenge Logo" />
    <p class="startSmall">(by David Toma)</p>

    <div class="row" style="margin-top:10px;">
      <input id="playerName" type="text" maxlength="14" placeholder="Your name (e.g. David)" />
      <input id="roomCode" type="text" maxlength="6" placeholder="ROOM (e.g. ABC123)" />
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="joinBtn" class="btnGreen">Join / Create</button>
      <button id="howBtn" class="btnGold">How to play</button>
    </div>

    <p class="hint" style="margin-top:12px;">
      Max 4 players. First player becomes <b>Challenger</b>.
    </p>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen">
  <div class="wrap">

    <!-- HUD -->
    <div class="panel">
      <div class="hudGrid">
        <div class="hudCell"><small>Phase</small><span class="hudValue" id="hudPhase">lobby</span></div>
        <div class="hudCell"><small>Role</small><span class="hudValue" id="hudRole">‚Äî</span></div>

        <div class="hudCell"><small>Night</small><span class="hudValue" id="hudNight">0/7</span></div>
        <div class="hudCell"><small>Fails</small><span class="hudValue" id="hudFails">0/3</span></div>

        <div class="hudCell"><small>Event</small><span class="hudValue" id="hudEvent">‚Äî</span></div>
        <div class="hudCell"><small>Timer</small><span class="hudValue" id="hudTimer">‚Äî</span></div>

        <div class="hudCell"><small>Supply</small><span class="hudValue" id="hudSupply">‚Äî</span></div>
        <div class="hudCell"><small>Power</small><span class="hudValue" id="hudPower">‚Äî</span></div>

        <div class="hudCell"><small>Hearts</small><span class="hudValue" id="hudHearts">‚Äî</span></div>
        <div class="hudCell"><small>Hunger</small><span class="hudValue" id="hudHunger">‚Äî</span></div>

        <div class="hudCell"><small>Players</small><span class="hudValue" id="hudPlayers">0/4</span></div>
        <div class="hudCell"><small>Sound</small>
          <span class="hudValue">
            <button id="soundBtn" class="btnGray" style="padding:10px 12px;border-radius:14px;font-size:16px;">üîá</button>
          </span>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="mainRow">

      <!-- FEED -->
      <div class="panel feed">
        <div class="feedHeader">Room Feed</div>
        <div id="feedBox" class="feedBox"></div>
      </div>

      <!-- NIGHT + ITEMS -->
      <div class="cards">
        <div class="panel nightPanel">
          <div class="nightTitle">
            <span>Night Card (3 sec)</span>
            <span id="nightSub" style="font-weight:900;opacity:.85;">‚Äî</span>
          </div>
          <div id="nightCard">Waiting‚Ä¶</div>
        </div>

        <div class="panel itemsPanel">
          <div class="itemsTitle">
            <span>Your Items</span>
            <span style="font-weight:900;opacity:.85;">tap + / ‚àí</span>
          </div>
          <div id="itemsGrid" class="itemsGrid"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- BOTTOM CONTROLS -->
  <div class="controls">
    <div class="panel controlsInner">
      <button id="inventoryBtn" class="btnGold">Inventory</button>
      <button id="tradeBtn" class="btnGold">Trade</button>

      <button id="pleaseBtn" class="btnGold">Please</button>
      <button id="roleActionBtn" class="btnGreen">Role Action</button>

      <button id="readyBtn" class="btnGreen">Ready</button>
      <button id="startNightBtn" class="btnRed">Start Night</button>
    </div>
  </div>
</div>

<!-- HOW -->
<div id="howBack" class="modalBack">
  <div class="panel modal">
    <h2>How to play</h2>
    <div class="hint">
      Survivors must survive <b>7 nights</b>.
      Challenger wins if <b>Fails reach 3</b> or all Survivors lose hearts.
      Challenger manages <b>Supply</b> and approves ‚ÄúPlease‚Äù requests.
    </div>
    <div class="field">
      <button class="btnGold" id="closeHow">Close</button>
    </div>
  </div>
</div>

<!-- INVENTORY -->
<div id="invBack" class="modalBack">
  <div class="panel modal">
    <h2>Inventory</h2>
    <div class="hint">Add an item to your inventory (syncs to Firebase).</div>
    <div class="field">
      <input id="invInput" type="text" maxlength="18" placeholder="e.g. Rope" />
      <button id="invAddBtn" class="btnGreen">Add</button>
      <button id="invCloseBtn" class="btnGold">Close</button>
    </div>
  </div>
</div>

<!-- TRADE -->
<div id="tradeBack" class="modalBack">
  <div class="panel modal">
    <h2>Trade</h2>
    <div class="hint">Pick player + item (dropdown, no typing).</div>

    <div class="field">
      <select id="tradePlayer"></select>
      <select id="tradeItem"></select>
      <select id="tradeQty">
        <option value="1">x1</option>
        <option value="2">x2</option>
        <option value="3">x3</option>
      </select>
    </div>

    <div class="field">
      <button id="tradeSendBtn" class="btnGreen">Send Offer</button>
      <button id="tradeCloseBtn" class="btnGold">Close</button>
    </div>

    <div class="hint">Demo: offers appear in Room Feed.</div>
  </div>
</div>

<!-- PLEASE (Survivor sends request) -->
<div id="pleaseBack" class="modalBack">
  <div class="panel modal">
    <h2>Please</h2>
    <div class="hint">Ask Challenger for help (costs Supply).</div>

    <div class="field">
      <select id="pleaseType">
        <option value="item">Item</option>
        <option value="heal">Heal (+1 heart)</option>
        <option value="skipfail">Skip Fail (-1 fail)</option>
      </select>

      <select id="pleaseItem"></select>
    </div>

    <div class="field">
      <button id="pleaseSendBtn" class="btnGreen">Send Request</button>
      <button id="pleaseCloseBtn" class="btnGold">Close</button>
    </div>

    <div class="hint" id="pleaseNote">Item option lets you request a specific item.</div>
  </div>
</div>

<!-- CHALLENGER INBOX (Approve/Reject + cost 1-2 supply) -->
<div id="inboxBack" class="modalBack">
  <div class="panel modal">
    <h2>Challenger Inbox</h2>
    <div class="hint">Approve requests with cost (1‚Äì2 Supply).</div>

    <div class="field">
      <select id="approveCost">
        <option value="1">Cost: 1 Supply</option>
        <option value="2">Cost: 2 Supply</option>
      </select>
      <button id="inboxCloseBtn" class="btnGold">Close</button>
    </div>

    <div id="inboxList" style="padding:6px;"></div>
  </div>
</div>

<!-- VIDEO OVERLAY -->
<div id="videoBack" class="modalBack">
  <div class="videoWrap">
    <video id="videoEl" playsinline muted></video>
    <div class="field" style="justify-content:center;margin-top:10px;">
      <button id="videoSkipBtn" class="btnGold">Skip</button>
    </div>
  </div>
</div>

<script>
  // =========================
  // FIREBASE CONFIG (YOURS)
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyD6T_zbq3-fhN10aCF9zZtWJxV0eMg8fZQ",
    authDomain: "survivalchallengedt.firebaseapp.com",
    databaseURL: "https://survivalchallengedt-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "survivalchallengedt",
    storageBucket: "survivalchallengedt.firebasestorage.app",
    messagingSenderId: "953781088335",
    appId: "1:953781088335:web:fc26e2fb17717004eeba3a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // =========================
  // CONSTANTS
  // =========================
  const MAX_PLAYERS = 4;
  const MAX_NIGHTS = 7;
  const FAIL_LIMIT = 3;
  const FEED_LIMIT = 3;

  const ASSETS = {
    music: "assets/survival.mp3",
    introCh: "assets/intro_challenger.mp4",
    introSu: "assets/intro_survivor.mp4",
    winSurvivors: "assets/win_survivors.mp4",
    winChallenger: "assets/win_challenger.mp4"
  };

  // Starter items
  const START_ITEMS = { Rope: 1, Torch: 1, Berries: 2 };

  const ITEM_ICONS = {
    Rope: "ü™¢", Torch: "üî•", Berries: "üçì", Trap: "ü™§",
    Wood: "ü™µ", Water: "üíß", Knife: "üî™", Bandage: "ü©π", Meat: "ü•©"
  };

  const PLEASE_ITEMS = ["Rope","Torch","Berries","Bandage","Water","Wood","Trap","Knife","Meat"];

  // Night deck (simple, playable)
  const NIGHT_DECK = [
    { title: "Bear", desc: "Need: Trap OR Torch. If not: lose 1 heart.", need: ["Trap","Torch"], penalty: { hearts:-1 } },
    { title: "Storm", desc: "Need: Rope. If not: +1 fail.", need: ["Rope"], penalty: { fails:+1 } },
    { title: "Cold Night", desc: "Need: Wood OR Torch. If not: hunger -15.", need: ["Wood","Torch"], penalty: { hunger:-15 } },
    { title: "Snake Bite", desc: "Need: Bandage. If not: lose 1 heart.", need: ["Bandage"], penalty: { hearts:-1 } },
    { title: "Hunt Chance", desc: "Need: Knife. If yes: +Meat.", need: ["Knife"], reward: { item:"Meat", qty:1 } }
  ];

  // =========================
  // STATE
  // =========================
  let myId = localStorage.getItem("sc_myId");
  if (!myId) {
    myId = Math.random().toString(36).slice(2, 10);
    localStorage.setItem("sc_myId", myId);
  }

  let roomCode = null;
  let myRole = "‚Äî";
  let soundOn = false;
  let audio = null;

  // =========================
  // UI HELPERS
  // =========================
  function showStart(){ document.getElementById("startScreen").style.display = "flex"; document.getElementById("gameScreen").style.display = "none"; }
  function showGame(){ document.getElementById("startScreen").style.display = "none"; document.getElementById("gameScreen").style.display = "block"; }
  function openModal(id){ document.getElementById(id).style.display = "flex"; }
  function closeModal(id){ document.getElementById(id).style.display = "none"; }
  function setText(id, v){ const el = document.getElementById(id); if(el) el.textContent = v; }

  function heartsStr(n){
    const c = Math.max(0, Math.min(9, n|0));
    return c>0 ? "‚ù§Ô∏è".repeat(c) : "‚Äî";
  }
  function iconFor(item){ return ITEM_ICONS[item] || "üéí"; }

  // =========================
  // VIDEO (muted, mp3 continues)
  // =========================
  async function playOverlayVideo(src, maxMs=5200){
    const back = document.getElementById("videoBack");
    const vid = document.getElementById("videoEl");
    const skip = document.getElementById("videoSkipBtn");

    return new Promise((resolve)=>{
      let done = false;

      function finish(){
        if(done) return;
        done = true;
        try{ vid.pause(); }catch(e){}
        vid.removeAttribute("src");
        vid.load();
        closeModal("videoBack");
        resolve();
      }

      skip.onclick = finish;

      openModal("videoBack");
      vid.muted = true;  // keep mp3 as main audio
      vid.playsInline = true;
      vid.src = src;

      const t = setTimeout(finish, maxMs);

      vid.onended = () => { clearTimeout(t); finish(); };
      vid.onerror = () => { clearTimeout(t); finish(); };

      // muted autoplay usually works; if blocked, still shows with manual play attempt
      vid.play().catch(()=>{ /* ignore */ });
    });
  }

  // =========================
  // SOUND
  // =========================
  function initAudio(){
    if(audio) return;
    audio = new Audio(ASSETS.music);
    audio.loop = true;
    audio.volume = 0.65;
  }
  async function toggleSound(){
    initAudio();
    soundOn = !soundOn;
    document.getElementById("soundBtn").textContent = soundOn ? "üîä" : "üîá";
    if(soundOn){
      try{ await audio.play(); }catch(e){}
    } else {
      audio.pause();
    }
    // anti spam feed
    if(!window.__lastSoundLog || Date.now() - window.__lastSoundLog > 8000){
      await pushFeed(soundOn ? "Sound ON." : "Sound OFF.");
      window.__lastSoundLog = Date.now();
    }
  }

  // =========================
  // FEED (limit = 3)
  // =========================
  function renderFeed(lines){
    const box = document.getElementById("feedBox");
    box.innerHTML = "";
    lines.forEach(m=>{
      const d = document.createElement("div");
      d.className = "feedLine";
      d.textContent = m;
      box.appendChild(d);
    });
    box.scrollTop = box.scrollHeight;
  }

  async function pushFeed(msg){
    if(!roomCode) return;
    const ref = db.ref(`rooms/${roomCode}/feed`).push();
    await ref.set({ msg, ts: Date.now() });
  }

  // =========================
  // INVENTORY
  // =========================
  function renderItems(inv){
    const grid = document.getElementById("itemsGrid");
    grid.innerHTML = "";
    const keys = Object.keys(inv || {}).filter(k => (inv[k]|0) > 0).sort();

    if(keys.length === 0){
      const empty = document.createElement("div");
      empty.className = "itemChip";
      empty.textContent = "Empty inventory.";
      grid.appendChild(empty);
      return;
    }

    keys.forEach(k=>{
      const chip = document.createElement("div");
      chip.className = "itemChip";

      const left = document.createElement("span");
      left.textContent = `${iconFor(k)} ${k} x${inv[k]}`;

      const plus = document.createElement("button");
      plus.className = "btnGreen miniBtn";
      plus.textContent = "+";
      plus.onclick = () => adjustItem(k, +1);

      const minus = document.createElement("button");
      minus.className = "btnRed miniBtn";
      minus.textContent = "‚àí";
      minus.onclick = () => adjustItem(k, -1);

      chip.appendChild(left);
      chip.appendChild(plus);
      chip.appendChild(minus);
      grid.appendChild(chip);
    });
  }

  async function adjustItem(item, delta){
    if(!roomCode) return;
    const ref = db.ref(`rooms/${roomCode}/players/${myId}/inventory/${item}`);
    const snap = await ref.get();
    const cur = (snap.val()|0);
    const next = Math.max(0, cur + delta);
    if(next === 0) await ref.remove();
    else await ref.set(next);
  }

  async function addItemByName(name){
    const item = (name||"").trim();
    if(!item) return;
    await adjustItem(item, +1);
  }

  // =========================
  // WIN CHECK
  // =========================
  async function checkWin(room){
    if(!roomCode || !room) return;

    if((room.fails|0) >= FAIL_LIMIT){
      await endGame("challenger");
      return;
    }

    if((room.night|0) >= MAX_NIGHTS){
      await endGame("survivors");
      return;
    }

    // All survivors hearts <=0 => challenger wins
    const ps = (await db.ref(`rooms/${roomCode}/players`).get()).val() || {};
    const surv = Object.values(ps).filter(p=>p.role==="Survivor");
    if(surv.length>0 && surv.every(p => (p.hearts|0) <= 0)){
      await endGame("challenger");
      return;
    }
  }

  async function endGame(winner){
    const roomRef = db.ref(`rooms/${roomCode}`);
    const room = (await roomRef.get()).val();
    if(!room || room.phase==="end") return;

    await roomRef.update({ phase:"end", winner });

    await pushFeed(winner==="survivors" ? "Survivors WIN! ‚úÖ" : "Challenger WINS! ‚úÖ");

    // Show winner video locally
    if(winner==="survivors") await playOverlayVideo(ASSETS.winSurvivors, 9000);
    else await playOverlayVideo(ASSETS.winChallenger, 9000);
  }

  // =========================
  // NIGHT: Start + Resolve (simple)
  // =========================
  async function startNight(){
    if(!roomCode) return;

    const roomRef = db.ref(`rooms/${roomCode}`);
    const room = (await roomRef.get()).val();
    if(!room) return;

    if(room.challengerId !== myId){
      alert("Only Challenger can Start Night.");
      return;
    }

    if(room.phase === "end") return;

    const nextNight = Math.min(MAX_NIGHTS, (room.night||0) + 1);
    const card = NIGHT_DECK[Math.floor(Math.random()*NIGHT_DECK.length)];

    // reset resolved flags
    const players = (await db.ref(`rooms/${roomCode}/players`).get()).val() || {};
    const updates = {};
    Object.keys(players).forEach(pid=>{
      updates[`players/${pid}/resolvedNight`] = null;
    });

    await roomRef.update({
      phase: "night",
      night: nextNight,
      event: card.title,
      nightCard: { ...card, ts: Date.now() },
      ...updates
    });

    await pushFeed(`Night ${nextNight}: ${card.title}`);
    await checkWin({ ...room, night: nextNight });

    // show card for everyone
    // (listener handles 3 sec pop)
  }

  async function roleAction(){
    if(!roomCode) return;

    const room = (await db.ref(`rooms/${roomCode}`).get()).val();
    const me = (await db.ref(`rooms/${roomCode}/players/${myId}`).get()).val();
    if(!room || !me) return;

    // Survivor: resolve current night
    if(me.role === "Survivor"){
      if(room.phase !== "night" || !room.nightCard){
        alert("No active night. Wait for Challenger to start.");
        return;
      }
      openResolveModal(room.nightCard);
      return;
    }

    // Challenger: open inbox
    openModal("inboxBack");
  }

  // Resolve modal (built inline)
  function openResolveModal(card){
    const backId = "resolveBack";
    let back = document.getElementById(backId);
    if(back) back.remove();

    back = document.createElement("div");
    back.id = backId;
    back.className = "modalBack";
    back.style.display = "flex";

    back.innerHTML = `
      <div class="panel modal">
        <h2>Resolve Night</h2>
        <div class="hint"><b>${card.title}</b>: ${card.desc}</div>
        <div class="hint">Need one of: <b>${(card.need||[]).join(" / ") || "‚Äî"}</b></div>

        <div class="field">
          <select id="useItemSel"></select>
          <button id="useItemBtn" class="btnGreen">Use Item</button>
          <button id="failBtn" class="btnRed">Fail</button>
          <button id="closeResolveBtn" class="btnGold">Close</button>
        </div>
        <div class="hint">Using the correct item avoids penalty. Failing applies penalty.</div>
      </div>
    `;

    document.body.appendChild(back);

    back.addEventListener("click",(e)=>{ if(e.target===back){ back.remove(); } });

    document.getElementById("closeResolveBtn").onclick = () => back.remove();

    // fill inventory
    db.ref(`rooms/${roomCode}/players/${myId}/inventory`).get().then(snap=>{
      const inv = snap.val()||{};
      const sel = document.getElementById("useItemSel");
      sel.innerHTML = "";
      const keys = Object.keys(inv).filter(k=>(inv[k]|0)>0).sort();
      keys.forEach(k=>{
        const o=document.createElement("option");
        o.value=k;
        o.textContent=`${iconFor(k)} ${k} (x${inv[k]})`;
        sel.appendChild(o);
      });
      if(keys.length===0){
        const o=document.createElement("option");
        o.value="";
        o.textContent="(no items)";
        sel.appendChild(o);
      }
    });

    document.getElementById("useItemBtn").onclick = async ()=>{
      const item = document.getElementById("useItemSel").value;
      if(!item){ alert("No item."); return; }
      await resolveNightWithItem(item, card);
      back.remove();
    };

    document.getElementById("failBtn").onclick = async ()=>{
      await resolveNightFail(card);
      back.remove();
    };
  }

  async function resolveNightWithItem(item, card){
    const need = card.need || [];
    const ok = need.includes(item);

    // consume item regardless (you chose to use it)
    await adjustItem(item, -1);

    if(ok && card.reward && card.reward.item){
      await adjustItem(card.reward.item, +(card.reward.qty||1));
      await pushFeed(`‚úÖ ${myId.slice(0,4)} used ${item} and found ${card.reward.item}!`);
    } else if(ok){
      await pushFeed(`‚úÖ ${myId.slice(0,4)} used ${item}.`);
    } else {
      await applyPenalty(card.penalty);
      await pushFeed(`‚ö†Ô∏è ${myId.slice(0,4)} used wrong item (${item}). Penalty applied.`);
    }

    await markResolved();
  }

  async function resolveNightFail(card){
    await applyPenalty(card.penalty);
    await pushFeed(`‚ùå ${myId.slice(0,4)} failed the night. Penalty applied.`);
    await markResolved();
  }

  async function applyPenalty(pen){
    if(!pen) return;

    const roomRef = db.ref(`rooms/${roomCode}`);
    const meRef = db.ref(`rooms/${roomCode}/players/${myId}`);

    await db.ref().update({
      ...(pen.fails ? { [`rooms/${roomCode}/fails`]: firebase.database.ServerValue.increment(pen.fails) } : {}),
      ...(pen.hearts ? { [`rooms/${roomCode}/players/${myId}/hearts`]: firebase.database.ServerValue.increment(pen.hearts) } : {}),
      ...(pen.hunger ? { [`rooms/${roomCode}/players/${myId}/hunger`]: firebase.database.ServerValue.increment(pen.hunger) } : {})
    });

    const room = (await roomRef.get()).val();
    await checkWin(room);
  }

  async function markResolved(){
    const room = (await db.ref(`rooms/${roomCode}`).get()).val();
    if(!room) return;

    await db.ref(`rooms/${roomCode}/players/${myId}/resolvedNight`).set(room.night || 0);

    // check if all survivors resolved => back to lobby
    const players = (await db.ref(`rooms/${roomCode}/players`).get()).val() || {};
    const survivors = Object.values(players).filter(p=>p.role==="Survivor");
    const nightNum = room.night||0;
    const allResolved = survivors.length>0 && survivors.every(p => (p.resolvedNight|0) === nightNum);

    if(allResolved){
      // challenger can start next; set phase back
      await db.ref(`rooms/${roomCode}`).update({ phase:"lobby" });
      await pushFeed("All Survivors resolved. Back to lobby.");
    }
  }

  // =========================
  // PLEASE SYSTEM
  // =========================
  function fillPleaseItems(){
    const sel = document.getElementById("pleaseItem");
    sel.innerHTML = "";
    PLEASE_ITEMS.forEach(it=>{
      const o=document.createElement("option");
      o.value=it;
      o.textContent=`${iconFor(it)} ${it}`;
      sel.appendChild(o);
    });
  }

  async function sendPlease(){
    const room = (await db.ref(`rooms/${roomCode}`).get()).val();
    const me = (await db.ref(`rooms/${roomCode}/players/${myId}`).get()).val();
    if(!room || !me) return;

    if(me.role !== "Survivor"){
      alert("Challenger uses Inbox (Role Action).");
      return;
    }

    const type = document.getElementById("pleaseType").value;
    const item = document.getElementById("pleaseItem").value;

    const req = {
      fromId: myId,
      fromName: me.name || myId.slice(0,4),
      type,
      item: type==="item" ? item : null,
      ts: Date.now(),
      status: "pending"
    };

    await db.ref(`rooms/${roomCode}/please`).push().set(req);
    await pushFeed(`üôè Please request from ${req.fromName}: ${type}${req.item ? " ("+req.item+")" : ""}`);
    closeModal("pleaseBack");
  }

  async function approvePlease(reqId){
    const cost = parseInt(document.getElementById("approveCost").value,10) || 1;

    const roomRef = db.ref(`rooms/${roomCode}`);
    const room = (await roomRef.get()).val();
    if(!room) return;

    if(room.challengerId !== myId){
      alert("Only Challenger can approve.");
      return;
    }

    // Transaction: spend supply safely
    const supplyRef = db.ref(`rooms/${roomCode}/supply`);
    const ok = await supplyRef.transaction(cur=>{
      cur = (cur|0);
      if(cur < cost) return; // abort
      return cur - cost;
    });

    if(!ok.committed){
      alert("Not enough Supply.");
      return;
    }

    const reqRef = db.ref(`rooms/${roomCode}/please/${reqId}`);
    const req = (await reqRef.get()).val();
    if(!req || req.status!=="pending"){
      alert("Request not pending.");
      return;
    }

    if(req.type === "item" && req.item){
      await adjustOtherPlayerItem(req.fromId, req.item, +1);
      await pushFeed(`‚úÖ Approved: ${req.fromName} gets ${req.item} (cost ${cost} supply).`);
    } else if(req.type === "heal"){
      await db.ref(`rooms/${roomCode}/players/${req.fromId}/hearts`).transaction(h=>{
        h = (h|0);
        return Math.min(6, h+1);
      });
      await pushFeed(`‚úÖ Approved: ${req.fromName} healed +1 heart (cost ${cost} supply).`);
    } else if(req.type === "skipfail"){
      await db.ref(`rooms/${roomCode}/fails`).transaction(f=>{
        f = (f|0);
        return Math.max(0, f-1);
      });
      await pushFeed(`‚úÖ Approved: -1 fail (cost ${cost} supply).`);
    }

    await reqRef.update({ status:"approved", cost, by: myId, doneTs: Date.now() });

    const newRoom = (await roomRef.get()).val();
    await checkWin(newRoom);
  }

  async function rejectPlease(reqId){
    const room = (await db.ref(`rooms/${roomCode}`).get()).val();
    if(!room) return;

    if(room.challengerId !== myId){
      alert("Only Challenger can reject.");
      return;
    }

    const reqRef = db.ref(`rooms/${roomCode}/please/${reqId}`);
    const req = (await reqRef.get()).val();
    if(!req || req.status!=="pending") return;

    await reqRef.update({ status:"rejected", by: myId, doneTs: Date.now() });
    await pushFeed(`‚ùå Rejected: ${req.fromName} (${req.type}${req.item ? " "+req.item : ""})`);
  }

  async function adjustOtherPlayerItem(pid, item, delta){
    const ref = db.ref(`rooms/${roomCode}/players/${pid}/inventory/${item}`);
    const snap = await ref.get();
    const cur = (snap.val()|0);
    const next = Math.max(0, cur + delta);
    if(next === 0) await ref.remove();
    else await ref.set(next);
  }

  function renderInbox(listObj){
    const box = document.getElementById("inboxList");
    box.innerHTML = "";

    const reqs = Object.entries(listObj||{})
      .map(([id,v])=>({id,...v}))
      .filter(x=>x.status==="pending")
      .sort((a,b)=>(a.ts||0)-(b.ts||0));

    if(reqs.length===0){
      const d=document.createElement("div");
      d.className="hint";
      d.textContent="No pending requests.";
      box.appendChild(d);
      return;
    }

    reqs.forEach(r=>{
      const card=document.createElement("div");
      card.className="panel";
      card.style.margin="8px 6px";
      card.style.padding="12px";
      card.style.background="rgba(255,255,255,.78)";

      card.innerHTML = `
        <div style="font-weight:1000;font-size:18px;margin-bottom:6px;">
          üôè ${r.fromName} ‚Äî ${r.type}${r.item ? " ("+r.item+")" : ""}
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btnGreen miniBtn" data-approve="${r.id}">Approve</button>
          <button class="btnRed miniBtn" data-reject="${r.id}">Reject</button>
        </div>
      `;

      box.appendChild(card);
    });

    box.querySelectorAll("[data-approve]").forEach(btn=>{
      btn.onclick = ()=> approvePlease(btn.getAttribute("data-approve"));
    });
    box.querySelectorAll("[data-reject]").forEach(btn=>{
      btn.onclick = ()=> rejectPlease(btn.getAttribute("data-reject"));
    });
  }

  // =========================
  // JOIN / ROOM
  // =========================
  async function joinOrCreate(){
    const name = (document.getElementById("playerName").value || "").trim() || ("Player-" + myId.slice(0,4));
    const code = (document.getElementById("roomCode").value || "").trim().toUpperCase();
    if(!code) { alert("Enter ROOM code (e.g. ABC123)"); return; }
    if(code.length < 3) { alert("Room code too short."); return; }

    roomCode = code;

    const roomRef = db.ref(`rooms/${roomCode}`);
    const snap = await roomRef.get();

    if(!snap.exists()){
      await roomRef.set({
        createdAt: Date.now(),
        phase: "lobby",
        night: 0,
        fails: 0,
        event: "‚Äî",
        timer: "‚Äî",
        challengerId: myId,
        supply: 4,
        power: 3,
        winner: null
      });
    }

    const room = (await roomRef.get()).val();
    const playersSnap = await db.ref(`rooms/${roomCode}/players`).get();
    const players = playersSnap.val() || {};
    const playerCount = Object.keys(players).length;

    if(playerCount >= MAX_PLAYERS && !players[myId]){
      alert("Room is full (max 4).");
      roomCode = null;
      return;
    }

    const isCh = room.challengerId === myId;
    myRole = isCh ? "Challenger" : "Survivor";

    const playerData = {
      id: myId,
      name,
      role: myRole,
      hearts: 3,
      hunger: isCh ? null : 70,
      ready: false,
      resolvedNight: null,
      joinedAt: Date.now()
    };

    await db.ref(`rooms/${roomCode}/players/${myId}`).set(playerData);

    // Starter inventory if empty
    const invRef = db.ref(`rooms/${roomCode}/players/${myId}/inventory`);
    const invSnap = await invRef.get();
    if(!invSnap.exists()){
      await invRef.set(START_ITEMS);
    }

    // Presence cleanup
    db.ref(`rooms/${roomCode}/players/${myId}`).onDisconnect().remove();

    showGame();
    await pushFeed(`${name} joined as ${myRole}.`);

    // Intro video (muted)
    await playOverlayVideo(isCh ? ASSETS.introCh : ASSETS.introSu, 5200);

    listenRoom();
  }

  // =========================
  // LISTENERS
  // =========================
  function listenRoom(){
    // Room state
    db.ref(`rooms/${roomCode}`).on("value", async (snap)=>{
      const r = snap.val();
      if (!r) return;

      setText("hudPhase", r.phase || "‚Äî");
      setText("hudNight", `${r.night||0}/${MAX_NIGHTS}`);
      setText("hudFails", `${r.fails||0}/${FAIL_LIMIT}`);
      setText("hudEvent", r.event || "‚Äî");
      setText("hudTimer", r.timer || "‚Äî");
      setText("hudSupply", (r.supply ?? "‚Äî"));
      setText("hudPower", (r.power ?? "‚Äî"));

      // Night card show 3 sec on new
      if (r.nightCard && r.nightCard.title){
        const age = Date.now() - (r.nightCard.ts || 0);
        if(age < 3500){
          const el = document.getElementById("nightCard");
          el.classList.remove("pop"); void el.offsetWidth; el.classList.add("pop");
          el.innerHTML = `<div>
            <div style="font-size:28px;font-weight:1000;margin-bottom:6px;">${r.nightCard.title}</div>
            <div style="font-size:15px;font-weight:900;opacity:.92;">${r.nightCard.desc || ""}</div>
            <div style="margin-top:8px;font-size:14px;font-weight:900;opacity:.85;">Need: ${(r.nightCard.need||[]).join(" / ") || "‚Äî"}</div>
          </div>`;
          setText("nightSub","LIVE");
        } else {
          setText("nightSub","‚Äî");
        }
      }

      // Winner state -> show video once per client
      if(r.phase === "end" && r.winner && !window.__winnerShown){
        window.__winnerShown = true;
        if(r.winner === "survivors") await playOverlayVideo(ASSETS.winSurvivors, 9000);
        else await playOverlayVideo(ASSETS.winChallenger, 9000);
      }

      await checkWin(r);
    });

    // Players state
    db.ref(`rooms/${roomCode}/players`).on("value", snap=>{
      const players = snap.val() || {};
      const ids = Object.keys(players);

      setText("hudPlayers", `${ids.length}/${MAX_PLAYERS}`);

      const me = players[myId];
      if(me){
        setText("hudRole", me.role || "‚Äî");
        setText("hudHearts", heartsStr(me.hearts ?? 0));
        setText("hudHunger", (me.role === "Challenger") ? "‚Äî" : ((me.hunger ?? 0) + ""));
      }

      // trade player dropdown
      const sel = document.getElementById("tradePlayer");
      if(sel){
        const cur = sel.value;
        sel.innerHTML = "";
        ids.filter(id=>id!==myId).forEach(id=>{
          const o = document.createElement("option");
          o.value = id;
          o.textContent = players[id].name || ("Player-" + id.slice(0,4));
          sel.appendChild(o);
        });
        if(cur) sel.value = cur;
      }
    });

    // My inventory
    db.ref(`rooms/${roomCode}/players/${myId}/inventory`).on("value", snap=>{
      const inv = snap.val() || {};
      renderItems(inv);

      // trade item dropdown
      const itSel = document.getElementById("tradeItem");
      if(itSel){
        const cur = itSel.value;
        itSel.innerHTML = "";
        const keys = Object.keys(inv).filter(k => (inv[k]|0) > 0).sort();
        keys.forEach(k=>{
          const o = document.createElement("option");
          o.value = k;
          o.textContent = `${iconFor(k)} ${k} (x${inv[k]})`;
          itSel.appendChild(o);
        });
        if(keys.includes(cur)) itSel.value = cur;
      }
    });

    // Feed: only last 3
    db.ref(`rooms/${roomCode}/feed`).orderByChild("ts").limitToLast(FEED_LIMIT).on("value", snap=>{
      const obj = snap.val() || {};
      const arr = Object.values(obj).sort((a,b)=>(a.ts||0)-(b.ts||0)).map(x=>x.msg);
      renderFeed(arr);
    });

    // Please inbox (Challenger)
    db.ref(`rooms/${roomCode}/please`).orderByChild("ts").limitToLast(30).on("value", snap=>{
      const reqs = snap.val() || {};
      renderInbox(reqs);
    });
  }

  // =========================
  // READY / TRADE
  // =========================
  async function toggleReady(){
    if(!roomCode) return;
    const ref = db.ref(`rooms/${roomCode}/players/${myId}/ready`);
    const snap = await ref.get();
    const cur = !!snap.val();
    await ref.set(!cur);
    await pushFeed(`${(!cur) ? "Ready ‚úÖ" : "Not ready ‚ùå"}`);
  }

  async function sendTrade(){
    if(!roomCode) return;

    const targetId = document.getElementById("tradePlayer").value;
    const item = document.getElementById("tradeItem").value;
    const qty = parseInt(document.getElementById("tradeQty").value, 10) || 1;

    if(!targetId){ alert("No target player."); return; }
    if(!item){ alert("No item to trade."); return; }

    const haveSnap = await db.ref(`rooms/${roomCode}/players/${myId}/inventory/${item}`).get();
    const have = haveSnap.val()|0;
    if(have < qty){ alert("Not enough of that item."); return; }

    await pushFeed(`Trade offer: ${item} x${qty} ‚Üí ${targetId.slice(0,4)}`);
    closeModal("tradeBack");
  }

  // =========================
  // WIRE UI
  // =========================
  showStart();

  document.getElementById("joinBtn").onclick = joinOrCreate;
  document.getElementById("howBtn").onclick = () => openModal("howBack");
  document.getElementById("closeHow").onclick = () => closeModal("howBack");

  document.getElementById("inventoryBtn").onclick = () => openModal("invBack");
  document.getElementById("invCloseBtn").onclick = () => closeModal("invBack");
  document.getElementById("invAddBtn").onclick = async () => {
    const v = document.getElementById("invInput").value;
    document.getElementById("invInput").value = "";
    await addItemByName(v);
    await pushFeed(`Added item: ${v}`);
  };

  document.getElementById("tradeBtn").onclick = () => openModal("tradeBack");
  document.getElementById("tradeCloseBtn").onclick = () => closeModal("tradeBack");
  document.getElementById("tradeSendBtn").onclick = sendTrade;

  document.getElementById("pleaseBtn").onclick = async () => {
    if(!roomCode) return;
    const me = (await db.ref(`rooms/${roomCode}/players/${myId}`).get()).val();
    if(me && me.role === "Challenger"){
      openModal("inboxBack");
      return;
    }
    fillPleaseItems();
    openModal("pleaseBack");
  };
  document.getElementById("pleaseCloseBtn").onclick = () => closeModal("pleaseBack");
  document.getElementById("pleaseSendBtn").onclick = sendPlease;

  document.getElementById("roleActionBtn").onclick = roleAction;

  document.getElementById("inboxCloseBtn").onclick = () => closeModal("inboxBack");

  document.getElementById("readyBtn").onclick = toggleReady;
  document.getElementById("startNightBtn").onclick = startNight;

  document.getElementById("soundBtn").onclick = toggleSound;

  // Please type UI
  document.getElementById("pleaseType").onchange = () => {
    const t = document.getElementById("pleaseType").value;
    document.getElementById("pleaseItem").style.display = (t==="item") ? "inline-block" : "none";
    document.getElementById("pleaseNote").textContent =
      t==="item" ? "Request a specific item." :
      t==="heal" ? "Ask Challenger for +1 heart." :
      "Ask Challenger to remove 1 fail.";
  };
  // init visibility
  document.getElementById("pleaseItem").style.display = "inline-block";

  // Close modals by clicking outside
  ["howBack","invBack","tradeBack","pleaseBack","inboxBack","videoBack"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("click",(e)=>{ if(e.target===el) closeModal(id); });
  });
</script>
</body>
</html>
