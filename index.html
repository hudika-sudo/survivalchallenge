<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Survival Challenge</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --pad: 12px;
      --radius: 18px;
      --cardRadius: 22px;
      --shadow: 0 10px 24px rgba(0,0,0,.28);
      --stroke: rgba(0,0,0,.20);

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);

      --stickyBarH: 120px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#2b1d0e;
      background:url("assets/wood.png") center/cover fixed no-repeat;
      overflow:hidden;
    }

    /* Main scroll container */
    .wrap{
      position:fixed;
      inset:0;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding:
        calc(var(--pad) + var(--safeTop))
        var(--pad)
        calc(var(--stickyBarH) + 28px + var(--safeBottom))
        var(--pad);
    }

    /* Paper cards */
    .panel{
      background:
        url("assets/paper.png") center/cover no-repeat,
        rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      border-radius: var(--cardRadius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
    }

    .titleRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 8px 6px 2px;
    }
    #logo{
      width:min(520px, 92vw);
      height:auto;
      display:block;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
    }

    /* Status grid */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .pill{
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 18px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
      min-height: 52px;
    }
    .pill b{ font-size: 18px; }
    .muted{ opacity:.7; font-weight:600; }

    /* Room feed */
    .feedBox{
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 10px;
      min-height: 72px;
    }
    .feedLine{
      padding: 6px 2px;
      border-bottom: 1px dashed rgba(0,0,0,.15);
      font-weight: 650;
    }
    .feedLine:last-child{ border-bottom:none; }

    /* Night card */
    .cardStage{
      width:100%;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow);
    }
    .cardVisual{
      position:relative;
      width:100%;
      aspect-ratio: 16/10;
      background:
        url("assets/card-frame.png") center/cover no-repeat;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .cardText{
      position:absolute;
      inset: 14% 14% 18% 14%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight: 900;
      font-size: clamp(18px, 4.4vw, 34px);
      text-shadow: 0 2px 0 rgba(255,255,255,.65);
    }
    .cardMeta{
      display:flex;
      gap:10px;
      justify-content:space-between;
      padding: 10px 12px;
      font-weight: 750;
    }

    /* Sticky action bar */
    .actionBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      height: var(--stickyBarH);
      padding: 12px 12px calc(12px + var(--safeBottom)) 12px;
      background: linear-gradient(to top, rgba(0,0,0,.35), rgba(0,0,0,0));
      pointer-events:none; /* important: allow clicks only on inner */
    }
    .actionInner{
      pointer-events:auto;
      max-width: 980px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Buttons */
    button{
      border:0;
      border-radius: 18px;
      padding: 14px 14px;
      font-size: 18px;
      font-weight: 900;
      color:#2b1d0e;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      transform: translateY(0);
      transition: transform .08s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(2px) scale(.99); }

    .btnGold{ background: linear-gradient(#ffe7a8,#e7be57); }
    .btnGreen{ background: linear-gradient(#9cf0a3,#3fcf59); }
    .btnRed{ background: linear-gradient(#ffb0b0,#ff4b4b); }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px 12px calc(12px + var(--safeBottom)) 12px;
      z-index: 999;
    }
    .modal{
      width: min(720px, 100%);
      border-radius: 22px;
      overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      background:
        url("assets/paper.png") center/cover no-repeat,
        rgba(255,255,255,.95);
      border: 1px solid rgba(0,0,0,.18);
      padding: 14px;
    }
    .modal h2{ margin: 0 0 10px 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select{
      flex: 1 1 180px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.2);
      font-size: 16px;
      background: rgba(255,255,255,.85);
      font-weight: 650;
    }
    .smallBtn{
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 900;
    }
    .list{
      margin-top: 12px;
      background: rgba(255,255,255,.65);
      border: 1px dashed rgba(0,0,0,.2);
      border-radius: 16px;
      padding: 10px;
      min-height: 70px;
    }
    .tag{
      display:inline-block;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.08);
      margin: 6px 6px 0 0;
      font-weight: 800;
    }

    /* Video overlay */
    .videoOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.85);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 2000;
      padding: 12px;
    }
    .videoOverlay video{
      width: min(920px, 96vw);
      max-height: 90vh;
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
      background:#000;
    }

    /* Prevent super-tall feed pushing everything */
    @media (min-width: 760px){
      .actionInner{ grid-template-columns: repeat(4, 1fr); }
      button{ font-size: 18px; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="wrap">

    <!-- Logo -->
    <div class="titleRow">
      <img id="logo" src="assets/logo.png" alt="Survival Challenge" />
    </div>

    <!-- Start/join -->
    <div class="panel" id="startPanel">
      <div class="row">
        <input id="roomInput" maxlength="6" placeholder="ROOM CODE (e.g. ABC123)" />
        <button class="btnGreen smallBtn" id="joinBtn">Join / Create</button>
      </div>
      <div style="margin-top:10px;font-weight:750;opacity:.8;">
        First player becomes Challenger. Max 4 players.
      </div>
    </div>

    <!-- Status -->
    <div class="panel" id="statusPanel" style="display:none;">
      <div class="grid">
        <div class="pill"><span class="muted">Phase</span><b id="uiPhase">lobby</b></div>
        <div class="pill"><span class="muted">Role</span><b id="uiRole">â€”</b></div>

        <div class="pill"><span class="muted">Night</span><b id="uiNight">0/7</b></div>
        <div class="pill"><span class="muted">Fails</span><b id="uiFails">0/3</b></div>

        <div class="pill"><span class="muted">Event</span><b id="uiEvent">â€”</b></div>
        <div class="pill"><span class="muted">Timer</span><b id="uiTimer">â€”</b></div>

        <div class="pill"><span class="muted">Supply</span><b id="uiSupply">â€”</b></div>
        <div class="pill"><span class="muted">Power</span><b id="uiPower">â€”</b></div>

        <div class="pill"><span class="muted">Hearts</span><b id="uiHearts">â€”</b></div>
        <div class="pill"><span class="muted">Hunger</span><b id="uiHunger">â€”</b></div>

        <div class="pill"><span class="muted">Players</span><b id="uiPlayers">0/4</b></div>
        <div class="pill">
          <span class="muted">Sound</span>
          <button class="btnGold smallBtn" id="soundBtn" style="padding:10px 12px;border-radius:999px;">ðŸ”‡</button>
        </div>
      </div>
    </div>

    <!-- Feed -->
    <div class="panel" id="feedPanel" style="display:none;">
      <h2 style="margin:0 0 10px 0;">Room Feed</h2>
      <div class="feedBox" id="feedBox"></div>
    </div>

    <!-- Night Card -->
    <div class="panel" id="nightPanel" style="display:none;">
      <h2 style="margin:0 0 10px 0;">Night Card</h2>
      <div class="cardStage">
        <div class="cardVisual">
          <div class="cardText" id="cardText">â€”</div>
        </div>
        <div class="cardMeta">
          <span>Show: <b id="cardCountdown">â€”</b></span>
          <span>Night: <b id="cardNight">0/7</b></span>
        </div>
      </div>
    </div>

    <!-- Spacer content so you can scroll past -->
    <div style="height: 6px;"></div>
  </div>

  <!-- Sticky actions -->
  <div class="actionBar" id="actionBar" style="display:none;">
    <div class="actionInner">
      <button class="btnGold" id="btnInventory">Inventory</button>
      <button class="btnGold" id="btnTrade">Trade</button>
      <button class="btnGreen" id="btnPlease">Please</button>
      <button class="btnRed" id="btnStartNight">Start Night</button>
    </div>
  </div>

  <!-- Inventory Modal -->
  <div class="modalBackdrop" id="invBack">
    <div class="modal">
      <h2>Inventory</h2>
      <div class="row">
        <input id="invAddInput" placeholder="e.g. Rope" />
        <button class="btnGreen smallBtn" id="invAddBtn">Add</button>
        <button class="btnRed smallBtn" id="invCloseBtn">Close</button>
      </div>
      <div class="list" id="invList"></div>
    </div>
  </div>

  <!-- Trade Modal -->
  <div class="modalBackdrop" id="tradeBack">
    <div class="modal">
      <h2>Trade</h2>
      <div class="row">
        <select id="tradeGive"></select>
        <select id="tradeWant"></select>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btnGreen smallBtn" id="tradeSendBtn">Send Offer</button>
        <button class="btnRed smallBtn" id="tradeCloseBtn">Close</button>
      </div>
      <div class="list" id="tradeInfo"></div>
    </div>
  </div>

  <!-- Please Modal -->
  <div class="modalBackdrop" id="pleaseBack">
    <div class="modal">
      <h2>Please (Survivor)</h2>
      <div class="row">
        <select id="pleaseType">
          <option value="item">Item</option>
          <option value="heal">Heal</option>
          <option value="skip">Skip Fail</option>
        </select>
        <select id="pleaseCost">
          <option value="1">Cost 1 Supply</option>
          <option value="2">Cost 2 Supply</option>
        </select>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btnGreen smallBtn" id="pleaseSendBtn">Send Request</button>
        <button class="btnRed smallBtn" id="pleaseCloseBtn">Close</button>
      </div>
      <div class="list" id="pleaseInfo"></div>
      <div style="margin-top:10px;font-weight:700;opacity:.8;">
        Challenger will approve/deny (auto demo logic).
      </div>
    </div>
  </div>

  <!-- Video overlays -->
  <div class="videoOverlay" id="videoOverlay">
    <video id="videoEl" playsinline></video>
  </div>

  <!-- Audio -->
  <audio id="bgm" src="assets/survival.mp3" loop preload="auto"></audio>

  <script>
    // ======== Mobile-visible error reporting (leave ON until stable) ========
    window.addEventListener("error", (e) => {
      alert("JS ERROR: " + (e.message || e.error));
    });
    window.addEventListener("unhandledrejection", (e) => {
      alert("PROMISE ERROR: " + (e.reason?.message || e.reason));
    });

    // ======== Firebase config (YOUR REAL VALUES) ========
    const firebaseConfig = {
      apiKey: "AIzaSyD6T_zbq3-fhN10aCF9zZtWJxV0eMg8fZQ",
      authDomain: "survivalchallengedt.firebaseapp.com",
      databaseURL: "https://survivalchallengedt-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "survivalchallengedt",
      storageBucket: "survivalchallengedt.firebasestorage.app",
      messagingSenderId: "953781088335",
      appId: "1:953781088335:web:fc26e2fb17717004eeba3a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ======== Helpers ========
    const $ = (id) => document.getElementById(id);
    const now = () => Date.now();

    function randId(len=8){
      return Math.random().toString(36).slice(2,2+len);
    }

    // Persistent player id
    let myId = localStorage.getItem("sc_myId");
    if(!myId){
      myId = randId(10);
      localStorage.setItem("sc_myId", myId);
    }

    let roomCode = null;
    let isChallenger = false;
    let unsub = null;

    // ======== UI State ========
    const state = {
      phase: "lobby",
      night: 0,
      maxNights: 7,
      fails: 0,
      maxFails: 3,
      event: "â€”",
      timer: "â€”",
      supply: 0,
      power: 0,
      hearts: 0,
      hunger: "â€”",
      playersCount: 0,
      cardText: "â€”",
      cardCountdown: "â€”"
    };

    // ======== Audio ========
    const bgm = $("bgm");
    let soundOn = false;

    function setSound(on){
      soundOn = on;
      $("soundBtn").textContent = on ? "ðŸ”Š" : "ðŸ”‡";
      if(on){
        bgm.volume = 0.7;
        bgm.play().catch(()=>{});
      }else{
        bgm.pause();
      }
    }
    $("soundBtn").onclick = () => {
      setSound(!soundOn);
      pushFeed(soundOn ? "Sound ON." : "Sound OFF.");
    };

    // ======== Video ========
    function playVideo(src){
      const ov = $("videoOverlay");
      const v = $("videoEl");
      v.src = src;
      v.currentTime = 0;
      v.muted = false;
      ov.style.display = "flex";
      v.play().catch(()=>{});
      v.onended = () => {
        ov.style.display = "none";
        v.src = "";
      };
      ov.onclick = () => {
        ov.style.display = "none";
        v.pause();
        v.src = "";
      };
    }

    // ======== Feed (limit 3) ========
    function renderFeed(lines){
      const box = $("feedBox");
      box.innerHTML = "";
      (lines || []).slice(-3).forEach(t => {
        const div = document.createElement("div");
        div.className = "feedLine";
        div.textContent = t;
        box.appendChild(div);
      });
    }

    async function pushFeed(text){
      if(!roomCode) return;
      const ref = db.ref(`rooms/${roomCode}/feed`);
      const snap = await ref.get();
      const arr = snap.exists() ? (snap.val() || []) : [];
      const next = [...arr, text].slice(-3);
      await ref.set(next);
    }

    // ======== Default items ========
    const START_ITEMS = ["Rope", "Torch", "Berries"];
    const ALL_ITEMS = ["Rope","Torch","Berries","Trap","Bandage","Water","Wood","Stone","Spear"];

    function renderInv(items){
      const box = $("invList");
      box.innerHTML = "";
      const arr = items || [];
      if(arr.length === 0){
        box.textContent = "Empty inventory.";
        return;
      }
      arr.forEach(it => {
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = it;
        box.appendChild(s);
      });
    }

    function fillSelect(sel, items){
      sel.innerHTML = "";
      items.forEach(it=>{
        const o = document.createElement("option");
        o.value = it;
        o.textContent = it;
        sel.appendChild(o);
      });
    }

    // ======== Room listener ========
    function applyUI(room){
      const players = room.players || {};
      const me = players[myId];

      state.phase = room.phase || "lobby";
      state.night = room.night || 0;
      state.fails = room.fails || 0;
      state.event = room.event || "â€”";
      state.timer = room.timerText || "â€”";
      state.playersCount = Object.keys(players).length;

      isChallenger = (room.challengerId === myId);

      state.supply = isChallenger ? (room.challengerSupply ?? 0) : (me?.supply ?? 0);
      state.power  = isChallenger ? (room.challengerPower  ?? 0) : (me?.power  ?? 0);

      state.hearts = me?.hearts ?? 0;
      state.hunger = isChallenger ? "â€”" : (me?.hunger ?? 0);

      // Night card view
      state.cardText = room.currentCard?.text || "â€”";
      state.cardCountdown = room.currentCard?.showUntil ? Math.max(0, Math.ceil((room.currentCard.showUntil - now())/1000)) + "s" : "â€”";

      // UI text
      $("uiPhase").textContent = state.phase;
      $("uiRole").textContent = isChallenger ? "Challenger" : "Survivor";
      $("uiNight").textContent = `${state.night}/${state.maxNights}`;
      $("uiFails").textContent = `${state.fails}/${state.maxFails}`;
      $("uiEvent").textContent = state.event;
      $("uiTimer").textContent = state.timer;

      $("uiSupply").textContent = state.supply;
      $("uiPower").textContent = state.power;

      $("uiHearts").textContent = "â¤ï¸".repeat(state.hearts || 0);
      $("uiHunger").textContent = state.hunger;
      $("uiPlayers").textContent = `${state.playersCount}/4`;

      $("cardText").textContent = state.cardText;
      $("cardCountdown").textContent = state.cardCountdown;
      $("cardNight").textContent = `${state.night}/${state.maxNights}`;

      renderFeed(room.feed || []);

      renderInv(me?.inventory || []);
      fillSelect($("tradeGive"), (me?.inventory || ["(empty)"]));
      fillSelect($("tradeWant"), ALL_ITEMS);

      // Show panels when in room
      $("statusPanel").style.display = "block";
      $("feedPanel").style.display = "block";
      $("nightPanel").style.display = "block";
      $("actionBar").style.display = "block";
    }

    function listenRoom(){
      if(unsub) unsub();
      const ref = db.ref(`rooms/${roomCode}`);
      const cb = (snap)=>{
        const room = snap.val();
        if(!room) return;
        applyUI(room);

        // Auto win/lose checks
        if(room.gameOver?.ended){
          if(room.gameOver.type === "WIN"){
            playVideo("assets/win.mp4");
          }
          if(room.gameOver.type === "LOSE"){
            // optional: add lose.mp4 later
          }
        }
      };
      ref.on("value", cb);
      unsub = ()=> ref.off("value", cb);
    }

    // ======== Room init ========
    async function joinOrCreate(code){
      roomCode = code;
      const roomRef = db.ref(`rooms/${roomCode}`);
      const snap = await roomRef.get();

      if(!snap.exists()){
        await roomRef.set({
          createdAt: now(),
          phase: "lobby",
          night: 0,
          fails: 0,
          event: "â€”",
          timerText: "â€”",
          challengerId: myId,
          challengerSupply: 6,
          challengerPower: 3,
          currentCard: { text:"â€”", showUntil: null },
          feed: []
        });
      }

      // Determine challenger
      const room = (await roomRef.get()).val();
      const challengerId = room.challengerId;
      isChallenger = (challengerId === myId);

      // Add/update player
      const meRef = db.ref(`rooms/${roomCode}/players/${myId}`);
      const meSnap = await meRef.get();

      if(!meSnap.exists()){
        await meRef.set({
          id: myId,
          name: "Player-" + myId.slice(0,4),
          role: isChallenger ? "Challenger" : "Survivor",
          hearts: 3,
          hunger: 70,
          supply: 3,
          power: 1,
          inventory: START_ITEMS.slice()
        });
        await pushFeed((isChallenger ? "Dt joined as Challenger." : "Player joined as Survivor."));
      }

      // Hide start panel
      $("startPanel").style.display = "none";

      // Play intro once on join
      // (you will upload assets/intro.mp4 later)
      // playVideo("assets/intro.mp4");

      listenRoom();
      setSound(false);
    }

    $("joinBtn").onclick = async ()=>{
      const code = $("roomInput").value.trim().toUpperCase();
      if(!code) return alert("Enter room code (6 chars).");
      await joinOrCreate(code);
    };

    // ======== Modals ========
    function openModal(back){ back.style.display = "flex"; }
    function closeModal(back){ back.style.display = "none"; }

    $("btnInventory").onclick = ()=> openModal($("invBack"));
    $("invCloseBtn").onclick = ()=> closeModal($("invBack"));

    $("btnTrade").onclick = ()=> openModal($("tradeBack"));
    $("tradeCloseBtn").onclick = ()=> closeModal($("tradeBack"));

    $("btnPlease").onclick = ()=>{
      if(isChallenger){
        alert("Only Survivors can use Please.");
        return;
      }
      openModal($("pleaseBack"));
      $("pleaseInfo").textContent = "Choose type + cost, then send.";
    };
    $("pleaseCloseBtn").onclick = ()=> closeModal($("pleaseBack"));

    // ======== Inventory add ========
    $("invAddBtn").onclick = async ()=>{
      if(!roomCode) return;
      const v = $("invAddInput").value.trim();
      if(!v) return;

      const invRef = db.ref(`rooms/${roomCode}/players/${myId}/inventory`);
      const snap = await invRef.get();
      const arr = snap.exists() ? (snap.val() || []) : [];
      const next = [...arr, v].slice(0, 20);
      await invRef.set(next);
      $("invAddInput").value = "";
      await pushFeed("Inventory: added " + v);
    };

    // ======== Trade (demo offer) ========
    $("tradeSendBtn").onclick = async ()=>{
      if(!roomCode) return;
      const give = $("tradeGive").value;
      const want = $("tradeWant").value;
      $("tradeInfo").textContent = `Offer sent: Give "${give}" â†’ Want "${want}" (demo log).`;
      await pushFeed(`Trade offer: give ${give} for ${want}.`);
    };

    // ======== Please system (demo approval) ========
    $("pleaseSendBtn").onclick = async ()=>{
      if(!roomCode) return;

      const type = $("pleaseType").value;
      const cost = parseInt($("pleaseCost").value, 10);

      // Create a request in room
      const req = {
        by: myId,
        type,
        cost,
        at: now(),
        status: "pending"
      };
      await db.ref(`rooms/${roomCode}/pleaseRequest`).set(req);
      await pushFeed(`Please request: ${type} (cost ${cost}).`);
      $("pleaseInfo").textContent = "Request sent. Waiting for Challenger...";

      // DEMO: auto-approve after 1.2s if challenger has supply
      setTimeout(async ()=>{
        const room = (await db.ref(`rooms/${roomCode}`).get()).val();
        const chSupply = room.challengerSupply ?? 0;
        if(chSupply < cost){
          await db.ref(`rooms/${roomCode}/pleaseRequest/status`).set("denied");
          await pushFeed("Challenger denied (not enough supply).");
          $("pleaseInfo").textContent = "Denied (not enough supply).";
          return;
        }

        // Deduct from challenger stash
        await db.ref(`rooms/${roomCode}/challengerSupply`).set(chSupply - cost);

        // Apply effect
        if(type === "heal"){
          const me = (await db.ref(`rooms/${roomCode}/players/${myId}`).get()).val();
          const newHearts = Math.min(5, (me.hearts ?? 0) + 1);
          await db.ref(`rooms/${roomCode}/players/${myId}/hearts`).set(newHearts);
          await pushFeed("Challenger approved: +1 heart.");
        }else if(type === "skip"){
          await pushFeed("Challenger approved: skip fail (demo).");
        }else{
          // item: give random item from list
          const item = ALL_ITEMS[Math.floor(Math.random()*ALL_ITEMS.length)];
          const invRef = db.ref(`rooms/${roomCode}/players/${myId}/inventory`);
          const snap = await invRef.get();
          const arr = snap.exists() ? (snap.val() || []) : [];
          await invRef.set([...arr, item].slice(0,20));
          await pushFeed("Challenger approved: got item " + item + ".");
        }

        await db.ref(`rooms/${roomCode}/pleaseRequest/status`).set("approved");
        $("pleaseInfo").textContent = "Approved âœ…";
      }, 1200);
    };

    // ======== Night start + card timer ========
    let cardTick = null;

    function startCardTick(){
      if(cardTick) clearInterval(cardTick);
      cardTick = setInterval(async ()=>{
        if(!roomCode) return;
        const room = (await db.ref(`rooms/${roomCode}`).get()).val();
        if(!room?.currentCard?.showUntil) return;

        const left = Math.max(0, Math.ceil((room.currentCard.showUntil - now())/1000));
        $("cardCountdown").textContent = left + "s";
        if(left <= 0){
          await db.ref(`rooms/${roomCode}/currentCard`).set({ text:"â€”", showUntil:null });
        }
      }, 250);
    }

    $("btnStartNight").onclick = async ()=>{
      if(!roomCode) return;

      const room = (await db.ref(`rooms/${roomCode}`).get()).val();
      if(room.challengerId !== myId){
        alert("Only Challenger can start night.");
        return;
      }

      const nextNight = Math.min(7, (room.night || 0) + 1);
      await db.ref(`rooms/${roomCode}/night`).set(nextNight);
      await db.ref(`rooms/${roomCode}/phase`).set("night");

      // Random event/card
      const cards = [
        "Bear attacks! Choose: Trap or Torch.",
        "Cold night! Need Fire (Torch/Wood).",
        "Snake bite! Need Bandage.",
        "Storm! Lose 1 Supply unless Shelter.",
        "Hunger spike! Survivors -10 hunger."
      ];
      const text = cards[Math.floor(Math.random()*cards.length)];
      await db.ref(`rooms/${roomCode}/currentCard`).set({ text, showUntil: now() + 8000 });

      await pushFeed("Night " + nextNight + " started.");
      startCardTick();

      // Win condition (survive 7 nights)
      if(nextNight >= 7){
        await db.ref(`rooms/${roomCode}/gameOver`).set({ ended:true, type:"WIN", at: now() });
        await pushFeed("WIN: Survivors survived 7 nights!");
      }
    };

    // Start ticking once user is in
    startCardTick();
  </script>
</body>
</html>
